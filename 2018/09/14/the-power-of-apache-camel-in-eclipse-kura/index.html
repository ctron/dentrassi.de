<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href="https://staging.dentrassi.de/main.css?h=1bb5ac0ebcacce2b719e" rel=stylesheet><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var a="https://logs.dentrassi.de/";_paq.push(['setTrackerUrl',a+ 'matomo.php']);_paq.push(['setSiteId','1']);var b=document,c=b.createElement('script'),d=b.getElementsByTagName('script')[0];c.async=true;c.src=a+ 'matomo.js';d.parentNode.insertBefore(c,d)})()</script><link href=https://staging.dentrassi.de/2018/09/14/the-power-of-apache-camel-in-eclipse-kura/ rel=canonical><meta content="With the upcoming version of Eclipse Kura 4, we will see some nice new features for the embedded Apache Camel runtime. This tutorial walks you through the Camel integration of Kura wires, which allows you to bridge both technologies, and leverage the power of Apache Camel for your solutions on the IoT gateway.
" name=description><meta content=article property=og:type><meta content="ctron's blog" property=og:site_name><meta content="Leveraging the power of Apache Camel in Eclipse Kura" property=og:title><meta content=https://staging.dentrassi.de/2018/09/14/the-power-of-apache-camel-in-eclipse-kura property=og:url><meta content="With the upcoming version of Eclipse Kura 4, we will see some nice new features for the embedded Apache Camel runtime. This tutorial walks you through the Camel integration of Kura wires, which allows you to bridge both technologies, and leverage the power of Apache Camel for your solutions on the IoT gateway.
" property=og:description><meta content="Jens Reimann" property=og:author_name><meta content=https://dentrassi.de property=og:author_url><meta content=summary name=twitter:card><meta content=@ctron name=twitter:site><meta content="Leveraging the power of Apache Camel in Eclipse Kura" name=twitter:title><meta content="With the upcoming version of Eclipse Kura 4, we will see some nice new features for the embedded Apache Camel runtime. This tutorial walks you through the Camel integration of Kura wires, which allows you to bridge both technologies, and leverage the power of Apache Camel for your solutions on the IoT gateway.
" name=twitter:description><meta content=Apache property=article:tag><meta content=Camel property=article:tag><meta content=Eclipse property=article:tag><meta content=IoT property=article:tag><meta content=Kura property=article:tag><title>Leveraging the power of Apache Camel in Eclipse Kura – ctron's blog</title><link href=https://staging.dentrassi.de/rss.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=https://staging.dentrassi.de>ctron's blog</a><form class="de-c-search-form d-none d-lg-flex ms-auto me-3"><input placeholder="Search docs" aria-label=Search autocomplete=off class=form-control id=searchInput type=search><div class="shadow bg-white rounded" id=suggestions></div></form><div class="d-none d-md-flex ms-auto ms-lg-0 me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop=headline>Leveraging the power of Apache Camel in Eclipse Kura</h1><div><div class="de-c-post-meta text-muted"><ul class=list-inline><li class=list-inline-item><span>12 minute read</span> <meta content=2274 itemprop=wordCount> <span class=d-none itemprop=author itemscope itemtype=https://schema.org/Person> <a href=https://dentrassi.de itemprop=url> <span itemprop=name>Jens Reimann</span> </a> </span><li class=list-inline-item><span content=2018-09-14T15:52:25+02:00 itemprop=datePublished>14 September 2018</span><li class=list-inline-item><span><a class=link-secondary href=/categories/development>Development</a></span></ul><ul class=list-inline><li class=list-inline-item><a class=link-secondary href=https://staging.dentrassi.de/tags/apache/>#apache</a> <a class=link-secondary href=https://staging.dentrassi.de/tags/camel/>#camel</a> <a class=link-secondary href=https://staging.dentrassi.de/tags/eclipse/>#eclipse</a> <a class=link-secondary href=https://staging.dentrassi.de/tags/iot/>#iot</a> <a class=link-secondary href=https://staging.dentrassi.de/tags/kura/>#kura</a></ul></div></div></section><hr><section class=de-article__body itemprop=articleBody><p>With the upcoming version of <a rel="noopener nofollow noreferrer" href=https://eclipse.org/kura target=_blank>Eclipse Kura</a> 4, we will see some nice new features for the embedded <a rel="noopener nofollow noreferrer" href=https://camel.apache.org target=_blank>Apache Camel</a> runtime. This tutorial walks you through the Camel integration of Kura wires, which allows you to bridge both technologies, and leverage the power of Apache Camel for your solutions on the IoT gateway.</p><span id=continue-reading></span><p>Kura Wires is a graph-oriented programming model of Eclipse Kura. It allows wiring up different components, like a Modbus client to the internal Kura Cloud Service. It is similar to <a rel="noopener nofollow noreferrer" href=https://nodered.org/ target=_blank>Node-RED</a>.<p>Apache Camel is a message-oriented integration platform with a rule-based routing approach. It has a huge eco-system of components, allowing to integrate numerous messaging endpoints, data formats, and scripting languages.<p>A graphical approach, like Kura Wires may be interesting for a single instance, which is manually administered. But assume that you want to re-deploy the same solution multiple times. In this case you would want to locally develop and test it. Have proper tooling like validation and debugging. And then you want to automatically package it and run a set of unit and integration tests. And only after that you would want to deploy this. This model is supported when you are using Apache Camel. There is a lot of tooling available, tutorials, training, books on how to work with Apache Camel. And you can make use of the over 100 components which Camel itself provides. In addition to that, you have a whole ecosystem around Apache Camel, which can extend this even more. So it is definitely worth a look.<h2 id=prerequisites>Prerequisites</h2><p>As a prerequisite, you will need an instance of Kura 4. As this is currently not yet released, you can also use a snapshot build of Kura 3.3, which will later become Kura 4.<p>If you don’t want to set up a dedicated device just for playing around, you can always use the Kura container image and it e.g. with Docker. There is a short introduction on how to get started with this at the DockerHub repository: <a rel="noopener nofollow noreferrer" href=https://hub.docker.com/r/ctron/kura/ target=_blank>https://hub.docker.com/r/ctron/kura/</a><p>Starting a new Kura instance is as easy as:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>docker</span><span> run</span><span style=color:#e45649> -ti</span><span> ctron/kura:develop</span><span style=color:#e45649> -p</span><span> 8080:8080
</span></code></pre><p>The following tutorial assumes that you have already set up Kura, and started with a fresh instance.<h2 id=baby-steps>Baby Steps</h2><p>The first step we take is to create a very simple, empty, Camel Context and hook and directly hook up a Camel endpoint without further configuration.<h3 id=new-camel-context>New Camel Context</h3><p>As a first step, we create a new XML Router Camel context:<ul><li>Open the Kura Web UI<li>Click on the “+” button next to the services search box<li>Select the <code>org.eclipse.kura.camel.xml.XmlRouterComponent</code> factory<li>Enter the name <code>camel1</code><li>Press “Submit”</ul><p><img alt="New Camel Context Component" src=https://dentrassi.de/wp-content/uploads/Selection_524.png><p>A new service should appear in the left side navigation area. Sometimes it happens that the service does not show up, but reloading the Web UI will reveal the newly created service.<p>Now select the service and edit the newly created context. Clear out the “Router XML” and only leave the root element:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>routes </span><span style=color:#c18401>xmlns</span><span>=</span><span style=color:#50a14f>"http://camel.apache.org/schema/spring"</span><span>>
</span><span>&LT/</span><span style=color:#e45649>routes</span><span>>
</span></code></pre><p>In the field “Required Camel Components” add the <code>stream</code> component. Click on “Apply” to activate the changes. This will configure the Camel context to have no routes, but wait for the <code>stream</code> component to be present in the OSGi runtime. The <code>stream</code> component is a default component, provided by the Eclipse Kura Camel runtime. The Camel context should be ready immediately and will be registered as an OSGi service for others to consume.<p><img alt src=https://dentrassi.de/wp-content/uploads/Selection_525.png><h3 id=the-wires-graph>The Wires Graph</h3><p>The next step is to configure the Kura Wires graph:<ul><li>Switch to “Wire Graph” in the navigation pane<li>Add a new “Timer” component named <code>timer1</code> <ul><li>Configure the component to fire every second</ul><li>Add a new “Camel Producer” named <code>producer1</code> <ul><li>Set the Context ID field of the component to <code>camel1</code><li>Set the endpoint URI to <code>stream:out</code></ul><li>Connect the nodes <code>timer1</code> and <code>producer1</code><li>Click on <code>Apply</code> to activate the changes</ul><p><img alt src=https://dentrassi.de/wp-content/uploads/Selection_526.png><p>If you look at the console of the Kura instance, then you should see something like this:<pre style=background:#fafafa;color:#383a42><code><span>org.eclipse.kura.wire.WireEnvelope@bdc823c
</span><span>org.eclipse.kura.wire.WireEnvelope@5b1f50f4
</span><span>org.eclipse.kura.wire.WireEnvelope@50851555
</span><span>org.eclipse.kura.wire.WireEnvelope@34cce95d
</span></code></pre><p><strong>Note:</strong> If you are running Kura on an actual device, then the output might be in the file <code>/var/log/kura-console.log</code>.<p>What is happening is, that the Kura wires timer component will trigger a Wires event every second. That event is passed along to the Camel endpoint <code>stream:out</code> in the Camel context <code>camel1</code>. This isn’t using any Camel routes yet. But this is a basic integration, which allows you to access all available Camel endpoints directly from Kura Wires.<h2 id=producer-consumer-processor>Producer, Consumer, Processor</h2><p>In addition to the “Producer” component, it is also possible to use the “Consumer”, or the “Processor”. The Consumer takes events from the Camel context and forwards them to the Kura Wires graph. While the “Processor” takes an event from the Wire Graph, processes it using Camel, and passes along the result to Wires again:<p><img alt src=https://dentrassi.de/wp-content/uploads/drawing_1.png><br> <img alt src=https://dentrassi.de/wp-content/uploads/drawing_2.png><p>For Producer and Consumer, this would be a unidirectional message exchange from a Camel point of view. The Processor component would use an “in”/”out” message exchange, which is more like “request/response”. Of course that only makes sense when you have an endpoint which actually hands back a response, like the HTTP client endpoint.<p><img alt src=https://dentrassi.de/wp-content/uploads/drawing_3.png><p>In the following sections, we will see that in most cases there will be a more complex route set up that the Camel Wire component would interact with, proxied by a <code>seda</code> Camel component. Still, the “in”, “out” flow of the Camel message exchange would be end-to-end between whatever endpoint you have and the Wires graph.<p><img alt src=https://dentrassi.de/wp-content/uploads/drawing_4.png><h2 id=getting-professional>Getting professional</h2><p>Apache Camel mostly uses the concept of routes. And while accessing an endpoint directly from the Kura Camel component technically works, I wouldn’t recommend it. Mainly due to the fact that you would be missing an abstraction layer, there is no way to inject anything between the Kura Wires component and the final destination at the Camel endpoint. You directly hook up Kura Wires with the endpoint and thus lose all ways that Camel allows you to work with your data.<p>So as a first step, let’s decouple the Camel endpoint from Kura Wires and provide an API for our Camel Context.<p>In the <code>camel1</code> configurations screen, change the “Router XML” to:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>routes </span><span style=color:#c18401>xmlns</span><span>=</span><span style=color:#50a14f>"http://camel.apache.org/schema/spring"</span><span>>
</span><span>    <</span><span style=color:#e45649>route</span><span>>
</span><span>        <</span><span style=color:#e45649>from </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"seda:input1"</span><span>/>
</span><span>        <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"stream:out"</span><span>/>
</span><span>    &LT/</span><span style=color:#e45649>route</span><span>>
</span><span>&LT/</span><span style=color:#e45649>routes</span><span>>
</span></code></pre><p>Then configure the <code>producer1</code> component in the Wire Graph to use the “Endpoint URI” <code>seda:input1</code> instead of directly using <code>stream:out</code>.<p>If everything is right, then you should still see the same output on the Kura console, but now Wires and Camel are decoupled and properly interfaced using an internal event queue, which allows us to use Camel routes for the following steps.<p>One benefit of this approach also is that you can now take the XML route definitions outside of Kura and test them in your local IDE. There are various IDE extensions for Eclipse, IntelliJ and Visual Studio, which can help to work with Camel XML route definitions. And of course, there are the JBoss Tools as well ;-). So you can easily test the routes outside of a running Kura instance and feed in emulated Kura Wires events using the <code>seda</code> endpoints.<h2 id=to-json>To JSON</h2><p>This first example already shows a common problem, when working with data, and even so for IoT use cases. The output of <code>org.eclipse.kura.wire.WireEnvelope@3e0cef10</code> is definitely not what is of much use. But Camel is great a converting data, so let’s make use of that.<p>As a first step we need to enable the JSON support for Camel:<ul><li>Navigate to “Packages”<li>Click on “Install/Upgrade”<li>Enter the URL: <code>https://repo1.maven.org/maven2/de/dentrassi/kura/addons/de.dentrassi.kura.addons.camel.gson/0.6.0/de.dentrassi.kura.addons.camel.gson-0.6.0.dp</code><li>Click on “Submit”</ul><p>After a while, the package <code>de.dentrassi.kura.addons.gson</code> should appear in the list of installed packages. It may happen that the list doesn’t properly refresh. Clicking on “refresh” or reloading the Web page will help.<p>Instead of downloading the package directly to the Kura installation you can also download the file to your local machine and then upload it by providing the file in the “Install/Upgrade” dialog box.<p>As a next step, you need to change the “Router XML” of the Camel context <code>camel1</code> to the following configuration:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>routes </span><span style=color:#c18401>xmlns</span><span>=</span><span style=color:#50a14f>"http://camel.apache.org/schema/spring"</span><span>>
</span><span>    <</span><span style=color:#e45649>route</span><span>>
</span><span>        <</span><span style=color:#e45649>from </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"seda:input1"</span><span>/>
</span><span>        <</span><span style=color:#e45649>marshal</span><span>><</span><span style=color:#e45649>json </span><span style=color:#c18401>library</span><span>=</span><span style=color:#50a14f>"Gson"</span><span>/>&LT/</span><span style=color:#e45649>marshal</span><span>>
</span><span>        <</span><span style=color:#e45649>transform</span><span>><</span><span style=color:#e45649>simple</span><span>>${body}\n&LT/</span><span style=color:#e45649>simple</span><span>>&LT/</span><span style=color:#e45649>transform</span><span>>
</span><span>        <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"stream:out"</span><span>/>
</span><span>    &LT/</span><span style=color:#e45649>route</span><span>>
</span><span>&LT/</span><span style=color:#e45649>routes</span><span>>
</span></code></pre><p>In the Kura console you will now see that we successfully transformed the internal Kura Wires data format to simple JSON:<pre class=language-json data-lang=json style=background:#fafafa;color:#383a42><code class=language-json data-lang=json><span>{</span><span style=color:#50a14f>"value"</span><span>:[{</span><span style=color:#50a14f>"properties"</span><span>:{</span><span style=color:#50a14f>"TIMER"</span><span>:{}}}],</span><span style=color:#50a14f>"identification"</span><span>:</span><span style=color:#50a14f>"org.eclipse.kura.wire.Timer-1536913933101-5"</span><span>,</span><span style=color:#50a14f>"scope"</span><span>:</span><span style=color:#50a14f>"WIRES"</span><span>}
</span></code></pre><p>This change did intercept the internal Kura wires objects and serialized them into proper JSON structures. The following step simply appends the content with a “newline” character in order to have a more readable output on the command line.<h2 id=transforming-data>Transforming data</h2><p>Depending on your IoT use case, transforming data can become rather complex. Camel is good at handling this. Transforming, filtering, splitting, aggregating, … for this tutorial I want to stick to a rather simple example, in order to focus in the integration between Kura and Camel, and less on the powers of Camel itself.<p>As the next step will use the “Groovy” script language to transform data, we will need to install an additional package using the same way as before: <code>https://repo1.maven.org/maven2/de/dentrassi/kura/addons/de.dentrassi.kura.addons.camel.groovy/0.6.0/de.dentrassi.kura.addons.camel.groovy-0.6.0.dp</code><p>Then go ahead and modify the “Router XML” to include a transformation step, add the following content before the JSON conversion:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>transform</span><span>><</span><span style=color:#e45649>groovy</span><span>>
</span><span>return  ["value": new Random().nextInt(10), "timer": request.body.identification ];
</span><span>&LT/</span><span style=color:#e45649>groovy</span><span>>&LT/</span><span style=color:#e45649>transform</span><span>>
</span></code></pre><p>The full XML context should now be:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>routes </span><span style=color:#c18401>xmlns</span><span>=</span><span style=color:#50a14f>"http://camel.apache.org/schema/spring"</span><span>>
</span><span>    <</span><span style=color:#e45649>route</span><span>>
</span><span>        <</span><span style=color:#e45649>from </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"seda:input1"</span><span>/>
</span><span>        <</span><span style=color:#e45649>transform</span><span>><</span><span style=color:#e45649>groovy</span><span>>
</span><span>        return  ["value": new Random().nextInt(10), "timer": request.body.identification ];
</span><span>        &LT/</span><span style=color:#e45649>groovy</span><span>>&LT/</span><span style=color:#e45649>transform</span><span>>
</span><span>        <</span><span style=color:#e45649>marshal</span><span>><</span><span style=color:#e45649>json </span><span style=color:#c18401>library</span><span>=</span><span style=color:#50a14f>"Gson"</span><span>/>&LT/</span><span style=color:#e45649>marshal</span><span>>
</span><span>        <</span><span style=color:#e45649>transform</span><span>><</span><span style=color:#e45649>simple</span><span>>${body}\n&LT/</span><span style=color:#e45649>simple</span><span>>&LT/</span><span style=color:#e45649>transform</span><span>>
</span><span>        <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"stream:out"</span><span>/>
</span><span>    &LT/</span><span style=color:#e45649>route</span><span>>
</span><span>&LT/</span><span style=color:#e45649>routes</span><span>>
</span></code></pre><p>After applying the changes, the output on the console should change to something like:<pre class=language-json data-lang=json style=background:#fafafa;color:#383a42><code class=language-json data-lang=json><span>{</span><span style=color:#50a14f>"value"</span><span>:</span><span style=color:#c18401>2</span><span>,</span><span style=color:#50a14f>"timer"</span><span>:</span><span style=color:#50a14f>"org.eclipse.kura.wire.Timer-1536913933101-5"</span><span>}
</span></code></pre><p>As you can see, we now created a new data structure, based on generated content and based on the original Kura Wires event information.<h2 id=off-to-the-eclipse-hono-http-adapter>Off to the Eclipse Hono HTTP Adapter</h2><p>Printing out JSON to the console is nice, but let’s get a bit more professional. Yes, Kura allows you to use its Kura specific MQTT data format. But what we want to send this piece of JSON to some HTTP endpoint, like the <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/hono target=_blank>Eclipse Hono</a> HTTP protocol adapter?<p>Camel has a huge variety of endpoints for connecting to various APIs, transport mechanisms and protocols. I doubt you directly would like your IoT gateway to contact Salesforce or Twitter, but using <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2017/04/27/opc-ua-with-apache-camel/ target=_blank>OPC UA</a>, MQTT, HTTP, <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2017/02/17/iec-60870-5-104-with-apache-camel/ target=_blank>IEC 60870</a>, might be a reasonable use case for IoT.<p>As a first step, we need to install Camel HTTP endpoint support: <code>https://repo1.maven.org/maven2/de/dentrassi/kura/addons/de.dentrassi.kura.addons.camel.http/0.6.0/de.dentrassi.kura.addons.camel.http-0.6.0.dp</code><p>The next step requires an instance of Eclipse Hono, thankfully there is a <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/hono/sandbox/ target=_blank>Hono sandbox server</a> running at <code>hono.eclipse.org</code>.<p>In the XML Router we need two steps for this. You can add them after the <code>to</code> element, so that we still see the JSON on the command line:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>setHeader </span><span style=color:#c18401>headerName</span><span>=</span><span style=color:#50a14f>"Content-Type"</span><span>><</span><span style=color:#e45649>constant</span><span>>application/json&LT/</span><span style=color:#e45649>constant</span><span>>&LT/</span><span style=color:#e45649>setHeader</span><span>>
</span><span><</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"https4://hono.eclipse.org:28080/telemetry?authenticationPreemptive=true</span><span style=color:#c18401>&ampamp;</span><span style=color:#50a14f>authUsername=sensor1@DEFAULT_TENANT</span><span style=color:#c18401>&ampamp;</span><span style=color:#50a14f>authPassword=hono-secret"</span><span>/>
</span></code></pre><p>The first step sets the content type to <code>application/json</code>, which is passed along by Hono to the AMQP network.<p>Yes, it really is <code>http4://</code>, this is not a typo but the Camel endpoint using Apache HttpClient 4.<p>You may need to register the device with Hono before actually publishing data to the instance. Also, it is necessary that a consumer is attached, which receives the data. Hono rejects devices publish data if no consumer is attached. Also see: <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/hono/getting-started/#publishing-data target=_blank>https://www.eclipse.org/hono/getting-started/#publishing-data</a><p>If you are using a custom deployment of Hono using the <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/hono/deployment/openshift_s2i/ target=_blank>OpenShift S2I</a> approach, then the <code>to</code> URL would look more like:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"https4://hono-adapter-http-vertx-sec-hono.my.openshift.cluster/telemetry?authenticationPreemptive=true</span><span style=color:#c18401>&ampamp;</span><span style=color:#50a14f>authUsername=sensor1@DEFAULT_TENANT</span><span style=color:#c18401>&ampamp;</span><span style=color:#50a14f>authPassword=hono-secret"</span><span>/>
</span></code></pre><h2 id=wrapping-it-up>Wrapping it up</h2><p>What we have seen so far is that, with a few lines of XML, it is possible to interface with Kura Wires, and start processing data that was originally not supported by Kura, sending to a target that also isn’t supported by Kura. On for that we only used a few lines of XML.<p>In addition to that, you can test and develop everything in a local, confined space. Without having to worry too much about actually running a Kura instance.<p>In <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2018/09/17/sunny-weather-apache-camel-kura-wires/ target=_blank>Part #2</a>, we will have a look at ways to get data from Camel back into Kura Wires. And in <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2018/09/19/apache-camel-java-dsl-eclipse-kura-wires/ target=_blank>Part #3</a> of this tutorial, we will continue with this approach and develop a Camel based solution, which can run inside of Kura, as well as outside, including actual unit tests.</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="d-flex d-md-none pb-3"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#prerequisites>Prerequisites</a><li><a class=link-body-emphasis href=#baby-steps>Baby Steps</a> <ul class="list-unstyled de-c-toc__second"><li><a class=link-body-emphasis href=#new-camel-context>New Camel Context</a><li><a class=link-body-emphasis href=#the-wires-graph>The Wires Graph</a></ul><li><a class=link-body-emphasis href=#producer-consumer-processor>Producer, Consumer, Processor</a><li><a class=link-body-emphasis href=#getting-professional>Getting professional</a><li><a class=link-body-emphasis href=#to-json>To JSON</a><li><a class=link-body-emphasis href=#transforming-data>Transforming data</a><li><a class=link-body-emphasis href=#off-to-the-eclipse-hono-http-adapter>Off to the Eclipse Hono HTTP Adapter</a><li><a class=link-body-emphasis href=#wrapping-it-up>Wrapping it up</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="An OpenID Connect command line client" class=link-body-emphasis href=/2024/03/16/oidc-command-line-client/>An OpenID Connect command line client</a><li><a title="Release of Trunk 0.19.0" class=link-body-emphasis href=/2024/03/11/trunk-0-19-0/>Release of Trunk 0.19.0</a><li><a title="Good news everyone: Trunk is back" class=link-body-emphasis href=/2024/01/16/good-news-everyone/>Good news everyone: Trunk is back</a><li><a title="Yew components for OpenID connect and OAuth2" class=link-body-emphasis href=/2023/10/22/yew-oauth2/>Yew components for OpenID connect and OAuth2</a><li><a title="trunk-ng, the fork of trunk" class=link-body-emphasis href=/2023/10/14/trunk-ng-the-fork-of-trunk/>trunk-ng, the fork of trunk</a></ul></div></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Categories</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/categories>All</a> </span></h2><ul class=list-unstyled><li><a class=link-body-emphasis href=https://staging.dentrassi.de/categories/development/>Development</a><li><a class=link-body-emphasis href=https://staging.dentrassi.de/categories/iot/>IoT</a><li><a class=link-body-emphasis href=https://staging.dentrassi.de/categories/technical-stuff/>Technical Stuff</a></ul></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Tags</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/tags>All</a> </span></h2><a class=link-body-emphasis href=https://staging.dentrassi.de/tags/apache/>#apache</a><a class=link-body-emphasis href=https://staging.dentrassi.de/tags/camel/>#camel</a><a class=link-body-emphasis href=https://staging.dentrassi.de/tags/eclipse/>#eclipse</a><a class=link-body-emphasis href=https://staging.dentrassi.de/tags/iot/>#iot</a><a class=link-body-emphasis href=https://staging.dentrassi.de/tags/kura/>#kura</a></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=https://staging.dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=https://staging.dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=https://staging.dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=https://staging.dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src="https://staging.dentrassi.de/js/bootstrap.bundle.min.js?h=82f64f62bb03c1bc1824"></script><script src="https://staging.dentrassi.de/elasticlunr.min.js?h=4f648b9e42abdef9c436" defer></script><script src="https://staging.dentrassi.de/js/search.js?h=ed51a29cb343a0c8a535" defer></script><script>window.searchIndexLocation="https://staging.dentrassi.de/search_index.en.json?h=19d4ff246655ef412d02"</script>