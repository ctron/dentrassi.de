<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=https://dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href="https://dentrassi.de/main.css?h=6ca7df27c656cad9f823" rel=stylesheet><meta content="So here comes a puzzle for you … You do have Apache Camel (2.17), which internally uses com.googlecode.concurrentlinkedhashmap, which uses sun.misc.Unsafe. Now you can argue a lot about this is necessary or not. I just is that way. So starting up Apache Camel in an OSGi container which does strict processing of classes, using Apache Camel will run into a “java.lang.NoClassDefFoundError” issue due to “sun/misc/Unsafe”.
" name=description><meta content=article property=og:type><meta content="ctron's blog" property=og:site_name><meta content="Camel, Kura and OSGi, struggling with `sun.misc.Unsafe`" property=og:title><meta content=https://dentrassi.de/2016/07/25/camel-kura-and-osgi-struggling-with-sun-misc-unsafe property=og:url><meta content="So here comes a puzzle for you … You do have Apache Camel (2.17), which internally uses com.googlecode.concurrentlinkedhashmap, which uses sun.misc.Unsafe. Now you can argue a lot about this is necessary or not. I just is that way. So starting up Apache Camel in an OSGi container which does strict processing of classes, using Apache Camel will run into a “java.lang.NoClassDefFoundError” issue due to “sun/misc/Unsafe”.
" property=og:description><meta content="Jens Reimann" property=og:author_name><meta content=https://dentrassi.de property=og:author_url><meta content=summary name=twitter:card><meta content=@ctron name=twitter:site><meta content="Camel, Kura and OSGi, struggling with `sun.misc.Unsafe`" name=twitter:title><meta content="So here comes a puzzle for you … You do have Apache Camel (2.17), which internally uses com.googlecode.concurrentlinkedhashmap, which uses sun.misc.Unsafe. Now you can argue a lot about this is necessary or not. I just is that way. So starting up Apache Camel in an OSGi container which does strict processing of classes, using Apache Camel will run into a “java.lang.NoClassDefFoundError” issue due to “sun/misc/Unsafe”.
" name=twitter:description><meta content=Equinox property=article:tag><meta content=OSGi property=article:tag><title>Camel, Kura and OSGi, struggling with `sun.misc.Unsafe` – ctron's blog</title><link href=https://dentrassi.de/2016/07/25/camel-kura-and-osgi-struggling-with-sun-misc-unsafe/ rel=canonical><link href=https://dentrassi.de/rss.xml rel=alternate title=RSS type=application/rss+xml><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var a="https://logs.dentrassi.de/";_paq.push(['setTrackerUrl',a+ 'matomo.php']);_paq.push(['setSiteId','1']);var b=document,c=b.createElement('script'),d=b.getElementsByTagName('script')[0];c.async=true;c.src=a+ 'matomo.js';d.parentNode.insertBefore(c,d)})()</script><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=https://dentrassi.de>ctron's blog</a><form class="de-c-search-form d-none d-lg-flex ms-auto me-3"><input placeholder="Search docs" aria-label=Search autocomplete=off class=form-control id=searchInput type=search><div class="shadow bg-white rounded" id=suggestions></div></form><div class="d-none d-md-flex ms-auto ms-lg-0 me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/oidc-cli/>OIDC Command Line Tool</a></ul></div><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop=headline>Camel, Kura and OSGi, struggling with `sun.misc.Unsafe`</h1><div><div class="de-c-post-meta text-muted"><ul class=list-inline><li class=list-inline-item><span>5 minute read</span> <meta content=911 itemprop=wordCount> <span class=d-none itemprop=author itemscope itemtype=https://schema.org/Person> <a href=https://dentrassi.de itemprop=url> <span itemprop=name>Jens Reimann</span> </a> </span><li class=list-inline-item><span content=2016-07-25T13:23:44+02:00 itemprop=datePublished>25 July 2016</span><li class=list-inline-item><span><a class=link-secondary href=/categories/development>Development</a></span></ul><ul class=list-inline><li class=list-inline-item><a class=link-secondary href=https://dentrassi.de/tags/equinox/>#equinox</a> <span> </span> <a class=link-secondary href=https://dentrassi.de/tags/osgi/>#osgi</a> <span> </span></ul></div></div></section><hr><section class=de-article__body itemprop=articleBody><p>So here comes a puzzle for you … You do have Apache Camel (2.17), which internally uses <code>com.googlecode.concurrentlinkedhashmap</code>, which uses <code>sun.misc.Unsafe</code>. Now you can argue a lot about this is necessary or not. I just is that way. So starting up Apache Camel in an OSGi container which does strict processing of classes, using Apache Camel will run into a “java.lang.NoClassDefFoundError” issue due to “sun/misc/Unsafe”.</p><span id=continue-reading></span><h2 id=the-cause>The cause</h2><p>The cause is rather simple. Apache Camel makes use of <code>sun.misc</code> and so it should declare that in the OSGi manifest. OSGi R6 (and version before that as well) defines in section “3.9.4” of the core specification that <code>java.*</code> is forwarded to he parent class loader, but the rest is not. So <code>sun.misc</code> will not go the parent class loader (which finally is the JVM) by default.<h2 id=solutions>Solutions</h2><p>As always, there are a few. There may be a few more possible than I describe here, but I don’t want to list any which require changing Apache Camel itself.<h3 id=fragments>Fragments</h3><figure><p><a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2016/07/25/camel-kura-and-osgi-struggling-with-sun-misc-unsafe/sun_misc_1/ target=_blank><img alt="Two Fragments" src=https://dentrassi.de/wp-content/uploads/sun_misc_1.png></a><figcaption>Two Fragments</figcaption></figure><p>OSGi fragments are a way to enhance an already existing OSGi bundle. So the kind of merge in into the bundle. So it is possible to create a fragment for Apache Camel which does <code>Import-Package: sun.misc</code>. This should quickly resolve the issue as long as the bundle is installed into you OSGi container at the same time Apache Camel is, so that it is available at the time Apache Camel is started. The host bundle has to be <code>org.apache.camel.camel-core</code>, since this is the bundle requiring <code>sun.misc.Unsafe</code>.<p>Of course this brings up the next issue, there is nobody who exports <code>sun.misc</code>. But there is again a way to fix this.<p>The actual provider of <code>sun.misc</code> is the JVM. However the JVM does not know about OSGi. But the OSGi container itself, the framework, can act as a proxy. So if the framework bundle (aka bundle zero) would export <code>sun.misc</code> it would be able to actually resolve the class by using the JVM bootclasspath. The solution therefore is another fragment, which performs an <code>Export-Package: sun.misc</code>. That will bring both bundles with their fragments together, correctly wiring up <code>sun.misc</code>.<p>But as we have seen before, the fragment requires a “host bundle” and this would be different when e.g. using Apache Felix instead of Eclipse Equinox.<p>Again, there is a solution. The system bundle is also know as <code>system.bundle</code>. So the fragment can specify <code>system.bundle</code> with the attribute <code>extension:=framework</code> as bundle host:<pre style=background:#fafafa;color:#383a42><code><span>Manifest-Version: 1.0
</span><span>Bundle-ManifestVersion: 2
</span><span>Bundle-SymbolicName: my.sun.misc.provider
</span><span>Bundle-Version: 1.0.0
</span><span>Fragment-Host: system.bundle; extension:=framework
</span><span>Export-Package: sun.misc
</span></code></pre><p>Of course you can also export other JVM internal packages using that way.<p>There are only two things to keep in mind. First of all, but is is true to all other solutions as well, if the JVM does not provide <code>sun.misc</code> then this won’t work. Since the class cannot be found. Second, and this is specific to this solution, if you start “camel-core” before those two fragments are installed, then you need to “refresh” the Apache Camel Core bundle in order for the OSGi framework to re-wire your imports/exports.<p>There are also some pre-made extension bundles for this setup. Just <a rel="noopener nofollow noreferrer" href=http://search.maven.org/#search%7Cga%7C1%7Csun.misc target=_blank>search maven central</a>.<h3 id=equinox-and-felix>Equinox and Felix</h3><p>Some setups of Felix and Equinox do provide an “out of the box” workaround. Equinox for example does automatically forward all failed class lookups to the boot class loader, as a last resort, in the case the framework is started by using the <code>org.eclipse.equinox.launcher_*.jar</code> instead of the <code>org.eclipse.osgi_*.jar</code> launcher.<h3 id=bootclasspath-delegation-for-equinox>Bootclasspath delegation for Equinox</h3><p>Eclipse Equinox also allows to set a few system properties in order to allow falling back to the bootclasspath and delegating the lookup of “sun.misc” to the JVM:<p>Also see: <a rel="noopener nofollow noreferrer" href=https://wiki.eclipse.org/Equinox_Boot_Delegation target=_blank>https://wiki.eclipse.org/Equinox_Boot_Delegation</a><dl><dt>osgi.compatibility.bootdelegation=true<dd>This fill fall back to the bootclassloader like using the launcher `org.eclipse.equinox.launcher`</dl><h3 id=bootclasspath-delegation-for-all>Bootclasspath delegation for all</h3><p>The OSGi core specification also allows to configure direct delegation of lookups to the boot classloader (Section 3.9.3 of the OSGi core specification):<dl><dt>org.osgi.framework.bootdelegation=sun.misc.\*<dd>This will forward requests for `sun.misc.\*` directly to the boot class loader.</dl><h2 id=conclusion>Conclusion</h2><p>Now people may complain “oh how complicates this OSGi-thingy is”. Well, “sun.misc.Unsafe” was never intended to be used outside the JVM. Java 9 will correct this with their module system. OSGi already can do that. But it also provides a way to solve this.<p>If you prefer to use system properties, a different launcher or the “two fragment” approach, that is up to you and your situation. For me the problem simply was to make it happen without changing either Apache Camel or the launcher configuration of Eclipse Kura. So I went with the “two fragments” approach.<h2 id=thanks>Thanks</h2><p>I am just writing this down in order to help others. And I got help from others to solve this myself. So thanks to some people who posted this “on the net”, it is a long time, I stumbled over you googling about a solutions some time ago. Sorry I forgot where I initially found this solution.<p>Also thanks to <a rel="noopener nofollow noreferrer" href=https://twitter.com/nbartlett target=_blank>Neil Bartlett</a> for pointing out the OSGi conform solution with <code>org.osgi.framework.bootdelegation</code>.</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="d-flex d-md-none pb-3"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#the-cause>The cause</a><li><a class=link-body-emphasis href=#solutions>Solutions</a> <ul class="list-unstyled de-c-toc__second"><li><a class=link-body-emphasis href=#fragments>Fragments</a><li><a class=link-body-emphasis href=#equinox-and-felix>Equinox and Felix</a><li><a class=link-body-emphasis href=#bootclasspath-delegation-for-equinox>Bootclasspath delegation for Equinox</a><li><a class=link-body-emphasis href=#bootclasspath-delegation-for-all>Bootclasspath delegation for all</a></ul><li><a class=link-body-emphasis href=#conclusion>Conclusion</a><li><a class=link-body-emphasis href=#thanks>Thanks</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=https://dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="ReSyMo: Remote System Monitoring" class=link-body-emphasis href=/2024/04/07/remote-system-monitoring/>ReSyMo: Remote System Monitoring</a><li><a title="An OpenID Connect command line client" class=link-body-emphasis href=/2024/03/16/oidc-command-line-client/>An OpenID Connect command line client</a><li><a title="Release of Trunk 0.19.0" class=link-body-emphasis href=/2024/03/11/trunk-0-19-0/>Release of Trunk 0.19.0</a><li><a title="Good news everyone: Trunk is back" class=link-body-emphasis href=/2024/01/16/good-news-everyone/>Good news everyone: Trunk is back</a><li><a title="Yew components for OpenID connect and OAuth2" class=link-body-emphasis href=/2023/10/22/yew-oauth2/>Yew components for OpenID connect and OAuth2</a></ul></div></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Categories</span> <span class=de-c-title__action> <a href=https://dentrassi.de/categories>All</a> </span></h2><ul class=list-unstyled><li><a class=link-body-emphasis href=https://dentrassi.de/categories/development/>Development</a><li><a class=link-body-emphasis href=https://dentrassi.de/categories/technical-stuff/>Technical Stuff</a></ul></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Tags</span> <span class=de-c-title__action> <a href=https://dentrassi.de/tags>All</a> </span></h2><a class=link-body-emphasis href=https://dentrassi.de/tags/equinox/>#equinox</a><span> </span><a class=link-body-emphasis href=https://dentrassi.de/tags/osgi/>#osgi</a><span> </span></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=https://dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=https://dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=https://dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=https://dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src="https://dentrassi.de/js/bootstrap.bundle.min.js?h=0833b2e9c3a26c258476"></script><script src="https://dentrassi.de/elasticlunr.min.js?h=4f648b9e42abdef9c436" defer></script><script src="https://dentrassi.de/js/search.js?h=ed51a29cb343a0c8a535" defer></script><script>window.searchIndexLocation="https://dentrassi.de/search_index.en.json?h=3600f91fa8754c3bc4d8"</script>