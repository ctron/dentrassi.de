<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href=/main.css rel=stylesheet><title>ctron's blog</title><link href=/atom.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href>ctron's blog</a><div class="d-flex ms-auto me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop="name headline">Talking to the cloud</h1><div><ul class="de-c-post-meta list-inline text-muted"><li class=list-inline-item><span>4 minute read</span> <meta content=735 itemprop=wordCount><li class=list-inline-item><span content=2017-05-24 itemprop=datePublished>24 May 2017</span></ul></div></section><hr><section class=de-article__body itemprop=articleBody><p>While working on <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/kapua/ target=_blank>Eclipse Kapua</a>, I wanted to do different tests, pushing telemetry data into the system. So I started to work on the <a rel="noopener nofollow noreferrer" href=https://github.com/eclipse/kapua/tree/develop/simulator-kura target=_blank>Kura simulator</a>, which can used to simulator an Eclipse Kura IoT gateway in a plain Java project, no special setup required. Now that helped a lot for unit testing and scale testing. Even <a rel="noopener nofollow noreferrer" href=http://download.eclipse.org/kapua/docs/develop/user-manual/en/simulator.html target=_blank>generating a few simple telemetry data streams</a> for simulating data works out of the box.</p><span id=continue-reading></span><p>But then again I wanted to have something more lightweight and controllable. With the simulator you actually derive some a simple class and get fully controlled by the simulator framework. That may work well in some cases, but in others you may want to turn over the control to the actual application. Assume you already have a component which is “in charge” of your data, and now you want to push this into the cloud. Of course you can do this somehow, working around that. But creating a nice API for that, which is simple and easy to understand is way more fun ;-)<p>So here is my take on a Gateway Client API, sending IoT data to the cloud, consuming command & control from it.<h3 id=intentions>Intentions</h3><p>I wanted to have a simple API, easy to understand, readable. Preventing you from making mistakes in the first place. And if something goes wrong, it should go wrong right away. Currently we go with MQTT, but there would be an option to go with HTTP as well, or AMQP in the future. And also for MQTT we have Eclipse Paho and FUSE MQTT. Both should be available, both may have special properties, but share some common ground. So implementing new providers should be possible, while sharing code should be easy as well.<h3 id=example>Example</h3><p>Now here is with what I came up with:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>try </span><span>(</span><span style=color:#c18401>Client</span><span> client </span><span style=color:#a626a4>= </span><span style=color:#c18401>KuraMqttProfile</span><span>.</span><span style=color:#e45649>newProfile</span><span>(</span><span style=color:#c18401>FuseClient</span><span>.</span><span style=color:#c18401>Builder</span><span>::</span><span style=color:#e45649>new</span><span>)
</span><span>  .</span><span style=color:#e45649>accountName</span><span>(</span><span style=color:#50a14f>"kapua-sys"</span><span>)
</span><span>  .</span><span style=color:#e45649>clientId</span><span>(</span><span style=color:#50a14f>"foo-bar-1"</span><span>)
</span><span>  .</span><span style=color:#e45649>brokerUrl</span><span>(</span><span style=color:#50a14f>"tcp://localhost:1883"</span><span>)
</span><span>  .</span><span style=color:#e45649>credentials</span><span>(</span><span style=color:#e45649>userAndPassword</span><span>(</span><span style=color:#50a14f>"kapua-broker"</span><span>, </span><span style=color:#50a14f>"kapua-password"</span><span>))
</span><span>  .</span><span style=color:#e45649>build</span><span>()) {
</span><span>
</span><span>  </span><span style=color:#a626a4>try </span><span>(</span><span style=color:#c18401>Application</span><span> application </span><span style=color:#a626a4>=</span><span> client.</span><span style=color:#e45649>buildApplication</span><span>(</span><span style=color:#50a14f>"app1"</span><span>).</span><span style=color:#e45649>build</span><span>()) {
</span><span>
</span><span>    </span><span style=color:#a0a1a7>// subscribe to a topic
</span><span>
</span><span>    application.</span><span style=color:#e45649>data</span><span>(</span><span style=color:#c18401>Topic</span><span>.</span><span style=color:#e45649>of</span><span>(</span><span style=color:#50a14f>"my"</span><span>, </span><span style=color:#50a14f>"receiver"</span><span>)).</span><span style=color:#e45649>subscribe</span><span>(</span><span style=color:#e45649>message </span><span style=color:#a626a4>-> </span><span>{
</span><span>      </span><span style=color:#c18401>System</span><span>.out.</span><span style=color:#e45649>format</span><span>(</span><span style=color:#50a14f>"Received: %s%n"</span><span>, message);
</span><span>    });
</span><span>
</span><span>    </span><span style=color:#a0a1a7>// cache sender instance
</span><span>
</span><span>    </span><span style=color:#c18401>Sender</span><span>&LTruntimeexception> sender </span><span style=color:#a626a4>=</span><span> application
</span><span>      .</span><span style=color:#e45649>data</span><span>(</span><span style=color:#c18401>Topic</span><span>.</span><span style=color:#e45649>of</span><span>(</span><span style=color:#50a14f>"my"</span><span>, </span><span style=color:#50a14f>"sender"</span><span>))
</span><span>      .</span><span style=color:#e45649>errors</span><span>(</span><span style=color:#e45649>ignore</span><span>());
</span><span>
</span><span>    </span><span style=color:#a626a4>int</span><span> i </span><span style=color:#a626a4>= </span><span style=color:#c18401>0</span><span>;
</span><span>    </span><span style=color:#a626a4>while </span><span>(</span><span style=color:#c18401>true</span><span>) {
</span><span>      </span><span style=color:#a0a1a7>// send
</span><span>      sender.</span><span style=color:#e45649>send</span><span>(</span><span style=color:#c18401>Payload</span><span>.</span><span style=color:#e45649>of</span><span>(</span><span style=color:#50a14f>"counter"</span><span>, i</span><span style=color:#a626a4>++</span><span>));
</span><span>      </span><span style=color:#c18401>Thread</span><span>.</span><span style=color:#e45649>sleep</span><span>(</span><span style=color:#c18401>1000</span><span>);
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Looks pretty simple right? On the background the MQTT connection is managed, payload gets encoded, birth certificates get exchanges and subscriptions get managed. But still the main application is in control of the data flow.<h3 id=how-to-do-this-at-home>How to do this at home</h3><p>If you want to have a look at the code, it is available on GitHub (<a rel="noopener nofollow noreferrer" href=https://github.com/ctron/kapua-gateway-client target=_blank>ctron/kapua-gateway-client</a>) and ready to consume on Maven Central (<a rel="noopener nofollow noreferrer" href=https://search.maven.org/#search%7Cga%7C1%7Cg%3A%22de.dentrassi.kapua%22 target=_blank>de.dentrassi.kapua</a>). But please be aware of the fact that this is a proof-of-concept, and may never become more than that.<p>Simply adding the following dependency to your project should be enough:<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>dependency</span><span>>
</span><span>  <</span><span style=color:#e45649>groupId</span><span>>de.dentrassi.kapua&LT/</span><span style=color:#e45649>groupId</span><span>>
</span><span>  <</span><span style=color:#e45649>artifactId</span><span>>kapua-gateway-client-provider-mqtt-fuse&LT/</span><span style=color:#e45649>artifactId</span><span>>
</span><span>  <</span><span style=color:#e45649>version</span><span>>0.2.0&LT/</span><span style=color:#e45649>version</span><span>> </span><span style=color:#a0a1a7>&LT!-- check for a more recent version -->
</span><span>&LT/</span><span style=color:#e45649>dependency</span><span>>
</span></code></pre><p>With this dependency you can use the example above. If you want to got for Paho instead of FUSE use <code>kapua-gateway-client-provider-mqtt-paho</code> instead.<h3 id=taking-for-a-test-drive>Taking for a test drive</h3><p>Now taking this for a test drive as even more fun. <a rel="noopener nofollow noreferrer" href=https://eclipse.org/smarthome target=_blank>Eclipse SmartHome</a> has the concept of a persistence system, where telemetry data gets stored in a time series like database. There exists a default implementation for rrdb4j. So re-implementing this interface for Kapua was quite easy and resulted in an example module which can be installed into the Karaf based OpenHAB 2 distribution with just a few commands:<pre style=background:#fafafa;color:#383a42><code><span>openhab> repo-add mvn:de.dentrassi.kapua/karaf/0.2.0/xml/features
</span><span>openhab> feature:install eclipse-smarthome-kapua-persistence
</span></code></pre><p>Then you need to re-configure the component over the “Paper UI” and point it towards your Kapua setup. Maybe you will need to tweak the “kapua.persist” file in order to define what gets persisted and when. And if everything goes well, your temperate readings will get pushed from SmartHome to Kapua.<h3 id=more-information>More information</h3><ul><li>GitHub repository – <a rel="noopener nofollow noreferrer" href=https://github.com/ctron/kapua-gateway-client target=_blank>ctron/kapua-gateway-client</a><li>Search Maven Central – <a rel="noopener nofollow noreferrer" href=https://search.maven.org/#search%7Cga%7C1%7Cg%3A%22de.dentrassi.kapua%22 target=_blank>de.dentrassi.kapua</a><li><a rel="noopener nofollow noreferrer" href=https://ctron.github.io/kapua-gateway-client/ target=_blank>Documentation</a></ul></section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#intentions>Intentions</a><li><a class=link-body-emphasis href=#example>Example</a><li><a class=link-body-emphasis href=#how-to-do-this-at-home>How to do this at home</a><li><a class=link-body-emphasis href=#taking-for-a-test-drive>Taking for a test drive</a><li><a class=link-body-emphasis href=#more-information>More information</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/blog/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/blog/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a><li><a title="A Rusty frontend: Patternfly & Yew" class=link-body-emphasis href=/blog/2021/01/08/rusty-frontend-patternfly-yew/>A Rusty frontend: Patternfly & Yew</a><li><a title="OpenShift Update Graph Visualizer, lessons learned" class=link-body-emphasis href=/blog/2020/08/02/openshift-update-graph-visualizer-lessons-learned/>OpenShift Update Graph Visualizer, lessons learned</a><li><a title="Quarkus – Supersonic Subatomic IoT" class=link-body-emphasis href=/blog/2020/06/30/quarkus-supersonic-subatomic-iot/>Quarkus – Supersonic Subatomic IoT</a></ul></div></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=/legal/contact/>Contact</a></div></div></div></footer><script src=/js/bootstrap.bundle.min.js></script><script defer src=/elasticlunr.min.js></script><script defer src=/search_index.en.js></script><script defer src=/js/search.js></script>