<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href=dentrassi.de/main.css rel=stylesheet><title>ctron's blog</title><link href=dentrassi.de/atom.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=dentrassi.de>ctron's blog</a><div class="d-flex ms-auto me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop="name headline">Writing RPM files … in plain Java</h1><div><ul class="de-c-post-meta list-inline text-muted"><li class=list-inline-item><span>8 minute read</span> <meta content=1469 itemprop=wordCount><li class=list-inline-item><span content=2016-04-15 itemprop=datePublished>15 April 2016</span></ul></div></section><hr><section class=de-article__body itemprop=articleBody><p>Now creating an RPM file is easy. There are a lot of tutorials <a href="https://www.google.com/#q=create+rpm" rel="noopener nofollow noreferrer" target=_blank>out there</a> on how write a <a rel="noopener nofollow noreferrer" href=http://www.rpm.org/max-rpm/ch-rpm-inside.html target=_blank>SPEC file</a> and build your RPM. Even when you are using Maven … with the exception that when you are on Windows or Mac OS X, the <a rel="noopener nofollow noreferrer" href=http://www.mojohaus.org/rpm-maven-plugin/ target=_blank>Maven RPM plugin</a> will still try to invoke <code>rpmbuild</code> in order to actually build the RPM file. The maven bundle simply creates a SPEC file, layout out the payload data and lets <code>rpmbuild</code> do the processing.</p><span id=continue-reading></span><p>My task now was to make it possible for <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/eclipsescada/ target=_blank>Eclipse NeoSCADA</a> to create configuration RPMs directly from inside the Eclipse IDE (running in Java), without the need to have <code>rpmbuild</code> on a Windows platform. Since I did write an RPM reader for <a rel="noopener nofollow noreferrer" href=https://packagedrone.org/ target=_blank>Package Drone</a> before, I did know a bit about the RPM file format. So this shouldn’t be a big deal?! … How naive ;-)<p>Now there is a bit of documentation about the RPM file format (<a rel="noopener nofollow noreferrer" title="RPM File Format" href=http://www.rpm.org/max-rpm/s1-rpm-file-format-rpm-file-format.html target=_blank>[1]</a>, <a rel="noopener nofollow noreferrer" href=https://docs.fedoraproject.org/ro/Fedora_Draft_Documentation/0.1/html/RPM_Guide/ch-package-structure.html target=_blank>[2]</a>) and there also is an implementation, called <a rel="noopener nofollow noreferrer" href=http://jrpm.sourceforge.net/ target=_blank>jRPM</a>, which can read RPM files in Java. But beside the fact that is was not updated for a long, long time, it cannot write RPM files.<h3 id=reading-rpms>Reading RPMs</h3><p>So why is writing RPM files so complicated? It isn’t. RPM is a binary format, designed in the 90ies using C. It uses structs, which get written out in the file stream. Some areas of the file are (the lead) are only left over for compatibility reasons and are ignored nowadays. The RPM file has two dictionary like structures, which can be used to store variable type data in a <code>integer</code> to <code>data</code> relation (called <q>headers</q>, one signature header, one package header). The end of the file is the actual payload section which holds a CPIO archive, which can be compressed e.g. using GZIP. Nothing fancy, easy to read if you are used to working with binary content. So in the past it was easy for me to write our own <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2015/12/03/parsing-rpms-in-java/ target=_blank>RPM reader for Package Drone</a>.<h3 id=writing-rpms>Writing RPMs</h3><p>Now writing RPMs is a completely different story. First of all you can’t simply ignore all those unused areas, you actually have to write them out. Next, the boths headers (which have nearly the same format) do have a fixed length record structure in the beginning and then a variable payload section.<p>Like this (please not, all <q>diagrams</q> in here are just sketches! For the real binary layout, please see the RPM documentations):<pre style=background:#fafafa;color:#383a42><code><span>
</span><span>         -----------------------------------------------
</span><span>         | Number Of Entries  | Payload Size           |
</span><span>         -----------------------------------------------
</span><span>Entry #1 | TAG #1 | TYPE | COUNT | OFFSET in payload   |
</span><span>Entry #2 | TAG #2 | TYPE | COUNT | OFFSET in payload   |
</span><span>Entry... | TAG... | TYPE | COUNT | OFFSET in payload   |
</span><span>Entry #n | TAG #n | TYPE | COUNT | OFFSET in payload   |
</span><span>         -----------------------------------------------
</span><span>Payload  |                                             |
</span><span>         |                                             |
</span><span>         |                                             |
</span><span>         |                                             |
</span><span>         -----------------------------------------------
</span><span>
</span></code></pre><p>Reading this structure is easy. You read the tags, look up in the big payload BLOB and interpret the data using the type information. Writing this out the same way caused the official RPM tool to reject my content. I did run this in my own reader which worked fine though. The first error message I ran into was <code>BAD, tag</code>. So what to do?<p>Searching the internet for “RPM” and “BAD, tag” is not really helpful if you don’t know what you are looking for. So, thanks to open source, I did check out the RPM source and looked into the code what could cause this error message.<p>My first mistake was I assume the position of the payload header data was irrelevant. But no, it wasn’t. Payload data has to be aligned inside the big payload field. While the payload field itself is aligned to 8 bytes.<p>But I did learn another thing from my look into the RPM source code. I knew there would be a lot more things coming up until I would be done with this task. The RPM code is full of special cases, legacy handling, weird logic in order to keep work around creating incompatible file formats. I don’t want to complain here, I know how the history of a productive tool can get to you. And the RPM file format is not intended to be a standardized format.<h3 id=my-highlight>My highlight</h3><p>I really don’t want to tell you about all the strange things I have seen. But there is one highlight which nearly made me give up until I ran into a helpful <a rel="noopener nofollow noreferrer" title="rpm-4.0.1 immutable header regions" href=https://www.redhat.com/archives/rpm-list/2000-December/msg00217.html target=_blank>mailing list entry from Jeff Johnson</a>.<p>I did outline the header section above. And I managed to write it correctly. But still the SHA1 header check failed, which prevented RPM to accept the file. The MD5 check however passed. Strange, since the SHA1 header check only checks the package header, while the MD5 check does check the package header plus the payload data.<p>Turned out, there is one feature in the RPM header which marks a region in the header as <q>immutable</q>. This was added at a later version and was kind of <q>hidden</q> inside the actual data, in order not to break the file format.<p>In short, a part of this header structure above, should be considered unchangeable, tag entry information and payload data. A marker will draw the line between mutable and immutable region. Like that:<pre style=background:#fafafa;color:#383a42><code><span>
</span><span>         -----------------------------------------------
</span><span>         | Number Of Entries   | Payload Size          |
</span><span>         -----------------------------------------------
</span><span>Entry #1 | TAG #1 | TYPE | COUNT | OFFSET in payload   |
</span><span>Entry #2 | TAG #2 | TYPE | COUNT | OFFSET in payload   |
</span><span>========================================================
</span><span>Entry... | TAG... | TYPE | COUNT | OFFSET in payload   |
</span><span>Entry #n | TAG #n | TYPE | COUNT | OFFSET in payload   |
</span><span>         -----------------------------------------------
</span><span>Payload  |                                             |
</span><span>         |                                             |
</span><span>========================================================
</span><span>         |                                             |
</span><span>         |                                             |
</span><span>         -----------------------------------------------
</span><span>
</span></code></pre><p>Now, interestingly, all RPM files which I did encounter marked the full header as immutable. So I am still not sure what that means.<p>The way this is stored is even more interesting, since the immutable region information is stored in the payload section, as a tag entry structure itself, pointing backwards with a negative offset, in bytes, of how many entries are considered immutable.<p>Look (␣ = padding):<pre style=background:#fafafa;color:#383a42><code><span>
</span><span>         ------------------------------------------
</span><span>         | Number Of Entries  | Payload Size      |
</span><span>         ------------------------------------------
</span><span>Entry #1 | 62     | BLOB      |   16  |   24      |
</span><span>Entry #2 | TAG #1 | STRING    |    1  |    0      |
</span><span>Entry #3 | TAG #2 | INT32     |    1  |   12      |
</span><span>Entry #4 | TAG #3 | INT16     |    4  |   20      |
</span><span>         ------------------------------------------
</span><span>Payload  |FOO BAR!␀␣␣␣000011223344XXXXXXXXXXXXXXXX|  
</span><span>         ------------------------------------------
</span><span>
</span><span>XXX...X = | 62 | BLOB | 16 | -(5*16) = -80 |
</span><span>
</span><span>
</span></code></pre><p>Although I though I would write it out correctly, I made one mistake. The entry with the special tag 62 (or 63) comes first, but still, its payload data comes last. The data structure would allow for a different position. It would be possible to write out the payload of Entry #1 first, and let the rest follow. But that does not work and will cause a SHA1 failure. Only placing the special marker first in the tag entry list and last in the payload section seems to work.<p>All this special handling explained a lot of oddities when I looked in the RPM source code at first.<h3 id=so-what>So what?</h3><p>First of all I have to say that a lot has been done from RPM version 4.11 to 4.13. I started out testing on Ubuntu, with RPM 4.11 and ended up using Fedora 23 with RPM 4.13. A few generic error messages where fixed into more helpful messages. The <a rel="noopener nofollow noreferrer" href=https://github.com/rpm-software-management/rpm target=_blank>source code is on GitHub</a> and has been cleaned up a lot.<p>While implementing the write support, I also tried to find another solution which is capable of writing RPM files in order to read their source code and get a better understanding. I did find none. Sure there is Python and Perl support for RPM, but this is all backed by native code and the <code>librpm</code>.<p>Well, now there is the first, independent implementation for reading AND writing RPM files aside the original RPM implementation. It is part of the Eclipse Package Drone project and <a rel="noopener nofollow noreferrer" href=https://github.com/eclipse/packagedrone/tree/master/bundles/org.eclipse.packagedrone.utils.rpm target=_blank>hosted on GitHub</a>. You can find first binaries <a rel="noopener nofollow noreferrer" href=https://oss.sonatype.org/content/groups/public/org/eclipse/packagedrone/org.eclipe.packagedrone.utils.rpm/ target=_blank>on Sonatype’s OSS repository</a>, and when Package Drone 0.13.0 is being released, these will be pushed to Maven Central as well.<h3 id=what-is-next>What is next?</h3><p>I do hope that I find some time in the future to write a Maven Plugin which is capable of creating RPMs using plain Java. So it should be easy to use Maven on Windows or Mac OS X to create RPMs during a Maven build.<p>There are probably also a <del datetime=2016-04-15T08:27:58+00:00>few</del> a lot special cases left over which need fixing … contributions are welcome ;-)</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#reading-rpms>Reading RPMs</a><li><a class=link-body-emphasis href=#writing-rpms>Writing RPMs</a><li><a class=link-body-emphasis href=#my-highlight>My highlight</a><li><a class=link-body-emphasis href=#so-what>So what?</a><li><a class=link-body-emphasis href=#what-is-next>What is next?</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/blog/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/blog/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a><li><a title="A Rusty frontend: Patternfly & Yew" class=link-body-emphasis href=/blog/2021/01/08/rusty-frontend-patternfly-yew/>A Rusty frontend: Patternfly & Yew</a><li><a title="OpenShift Update Graph Visualizer, lessons learned" class=link-body-emphasis href=/blog/2020/08/02/openshift-update-graph-visualizer-lessons-learned/>OpenShift Update Graph Visualizer, lessons learned</a><li><a title="Quarkus – Supersonic Subatomic IoT" class=link-body-emphasis href=/blog/2020/06/30/quarkus-supersonic-subatomic-iot/>Quarkus – Supersonic Subatomic IoT</a></ul></div></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src=dentrassi.de/js/bootstrap.bundle.min.js></script><script defer src=dentrassi.de/elasticlunr.min.js></script><script defer src=dentrassi.de/search_index.en.js></script><script defer src=dentrassi.de/js/search.js></script>