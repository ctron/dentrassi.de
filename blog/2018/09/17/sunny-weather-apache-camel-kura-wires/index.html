<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href=dentrassi.de/main.css rel=stylesheet><title>ctron's blog</title><link href=dentrassi.de/atom.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=dentrassi.de>ctron's blog</a><div class="d-flex ms-auto me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop="name headline">Sunny weather with Apache Camel and Kura Wires</h1><div><ul class="de-c-post-meta list-inline text-muted"><li class=list-inline-item><span>5 minute read</span> <meta content=959 itemprop=wordCount><li class=list-inline-item><span content=2018-09-17 itemprop=datePublished>17 September 2018</span></ul></div></section><hr><section class=de-article__body itemprop=articleBody><p><a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2018/09/14/the-power-of-apache-camel-in-eclipse-kura/ target=_blank>Part #1</a> of the <a rel="noopener nofollow noreferrer" href=https://camel.apache.org target=_blank>Apache Camel</a> to <a rel="noopener nofollow noreferrer" href=https://eclipse.org/kura target=_blank>Kura</a> Wires integration tutorial did focus on pushing data from Kura Wires to Camel and processing it there. But part #1 already mentioned that it is also possible to pull in data from Camel into Kura Wires.</p><span id=continue-reading></span><p><img alt="Apache Camel consumer node in Kura Wires" src=https://dentrassi.de/wp-content/uploads/drawing_2.png><h2 id=preparations>Preparations</h2><p>For the next step, you again need to install a Camel package, for interfacing with <a rel="noopener nofollow noreferrer" href=https://openweathermap.org/ target=_blank>Open Weather Map</a>: <code>https://repo1.maven.org/maven2/de/dentrassi/kura/addons/de.dentrassi.kura.addons.camel.weather/0.6.0/de.dentrassi.kura.addons.camel.weather-0.6.0.dp</code> The installation follows the same way as already described in part #1.<p>In addition to the installation of the package, you will also need to create an account at <a rel="noopener nofollow noreferrer" href=https://openweathermap.org/ target=_blank>https://openweathermap.org/</a> and create an API key. You can select the free tier plan, it is more than enough for our example.<h2 id=back-to-wires>Back to Wires</h2><p>Next, create a new Camel context, like before, and give it the ID “camel2”. Add the required component <code>weather</code>, the required language <code>groovy</code> and set the following XML router content (be sure to replace &LTappid> with your API token):<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>routes </span><span style=color:#c18401>xmlns</span><span>=</span><span style=color:#50a14f>"http://camel.apache.org/schema/spring"</span><span>>
</span><span>
</span><span>  <</span><span style=color:#e45649>route</span><span>>
</span><span>
</span><span>    <</span><span style=color:#e45649>from </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"weather:dummy?appid=</span><span><</span><span style=color:#e45649>YOUR </span><span style=color:#c18401>API TOKEN</span><span>></span><span style=color:#c18401>&ampamp;</span><span>lat=48.1351</span><span style=color:#c18401>&ampamp;</span><span>lon=11.5820"/>
</span><span>    <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"stream:out"</span><span>/>
</span><span>
</span><span>    <</span><span style=color:#e45649>unmarshal</span><span>><</span><span style=color:#e45649>json </span><span style=color:#c18401>library</span><span>=</span><span style=color:#50a14f>"Gson"</span><span>>&LT/</span><span style=color:#e45649>json</span><span>>&LT/</span><span style=color:#e45649>unmarshal</span><span>>
</span><span>    <</span><span style=color:#e45649>transform</span><span>><</span><span style=color:#e45649>simple</span><span>>${body["main"]["temp"]}&LT/</span><span style=color:#e45649>simple</span><span>>&LT/</span><span style=color:#e45649>transform</span><span>>
</span><span>    <</span><span style=color:#e45649>convertBodyTo </span><span style=color:#c18401>type</span><span>=</span><span style=color:#50a14f>"java.lang.Double"</span><span>/>
</span><span>    <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"stream:out"</span><span>/>
</span><span>
</span><span>    <</span><span style=color:#e45649>transform</span><span>><</span><span style=color:#e45649>groovy</span><span>>["TEMP": request.body-273.15]&LT/</span><span style=color:#e45649>groovy</span><span>>&LT/</span><span style=color:#e45649>transform</span><span>>
</span><span>    <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"stream:out"</span><span>/>
</span><span>    <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"seda:output1"</span><span>/>
</span><span>
</span><span>  &LT/</span><span style=color:#e45649>route</span><span>>
</span><span>
</span><span>&LT/</span><span style=color:#e45649>routes</span><span>>
</span></code></pre><p>After applying the changes, you can create two new components in the Wire graph:<ul><li>Create a new “Camel Consumer”, name it <code>consumer1</code> <ul><li>Set the Camel context ID <code>camel2</code><li>Set the endpoint URI <code>seda:output1</code></ul><li>Create a new “Logger”, name it <code>logger1</code> <ul><li>Set it to “verbose”</ul><li>Connect <code>consumer1</code> with <code>logger1</code><li>Click on “Apply” to activate the changes</ul><h2 id=what-does-it-do>What does it do?</h2><p>What this Camel context does, is to first start polling information from the Open Weather Map API. It requests with a manually provided GPS location, Munich.<p>It then parses the JSON, so that we can work with the data. Then it extracts the current temperature from the rather complex Open Weather Map structure. Of course, we could also use a different approach and extract additional or other information.<p>The extracted value could still be a number, represented internally by a string. So we ask Camel to ensure that the body of the message gets converted to a Double. If the body already is a double, then nothing will be done. But, if necessary, Camel will pull in its type converter system and optionally convert e.g. a string to a double by parsing it.<p>Now the body contains the raw value, as a Java double. But we still have two issues with that. The first one is, that the value is in degree Kelvin. Living in Germany, I would expect degree Celsius ;-) The second issue is, that Kura Wires requires some kind of key to that value, like a Map structure.<p>Fortunately, we easily can solve both issues with a short snippet of Groovy: <code>["TEMP": request.body-273.15]</code>. This will take the message (request) body, convert it to degree Celsius, and using this as a value for the key <code>TEMP</code> in the newly created map.<h2 id=checking-the-result>Checking the result</h2><p>As soon as you apply the changes, you should see some output on the console, which shows the incoming weather data:<pre style=background:#fafafa;color:#383a42><code><span>{"coord":{"lon":11.58,"lat":48.14},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"base":"stations","main":{"temp":297.72,"pressure":1021,"humidity":53,"temp_min":295.15,"temp_max":299.15},"visibility":10000,"wind":{"speed":1.5},"clouds":{"all":20},"dt":1537190400,"sys":{"type":1,"id":4914,"message":0.0022,"country":"DE","sunrise":1537160035,"sunset":1537204873},"id":2867714,"name":"Muenchen","cod":200}
</span><span>297.72
</span><span>{TEMP=24.57000000000005}
</span></code></pre><p>Every change, which should happen every second, shows three lines. First the raw JSON data, directly from the Open Weather Map API. Then the raw temperature in degree Kelvin, parsed by Camel and converted into a Java type already. Followed by the custom Map structure, created by the Groovy script. The beauty here is again, that you don’t need to fiddle around with custom data structures of the Kura Wires system, but can rely on standard data structures likes plain Java maps.<p>Looking at the Kura log file, which is by default <code>/var/log/kura.log</code>, you should see some output like this:<pre style=background:#fafafa;color:#383a42><code><span>2018-09-17T13:57:10,117 [Camel (camel-15) thread #31 - seda://output1] INFO  o.e.k.i.w.l.Logger - Received WireEnvelope from org.eclipse.kura.wire.camel.CamelConsume-1537188764126-1
</span><span>2018-09-17T13:57:10,117 [Camel (camel-15) thread #31 - seda://output1] INFO  o.e.k.i.w.l.Logger - Record List content:
</span><span>2018-09-17T13:57:10,118 [Camel (camel-15) thread #31 - seda://output1] INFO  o.e.k.i.w.l.Logger -   Record content:
</span><span>2018-09-17T13:57:10,118 [Camel (camel-15) thread #31 - seda://output1] INFO  o.e.k.i.w.l.Logger -     TEMP : 24.57000000000005
</span><span>2018-09-17T13:57:10,118 [Camel (camel-15) thread #31 - seda://output1] INFO  o.e.k.i.w.l.Logger -
</span></code></pre><p>This shows the same value, as processed by the Camel context but received by Kura Wires.<h2 id=wrapping-it-up>Wrapping it up</h2><p>Now, of course, a simple logger component isn’t really useful. But as you might now, Kura has the ability to connect to a GPS receiver. So you could also take the current position as an input to the Open Weather Map request. And instead of using my static GPS coordinates of Munich, you could query for the nearby weather information. So this might allow you to create some amazing IoT applications.<p>Stay tuned for <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2018/09/19/apache-camel-java-dsl-eclipse-kura-wires/ target=_blank>Part #3</a>, where we will look at a Camel based solution, which can run inside of Kura, as well as outside. Including actual unit tests, ready for continuous delivery.</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#preparations>Preparations</a><li><a class=link-body-emphasis href=#back-to-wires>Back to Wires</a><li><a class=link-body-emphasis href=#what-does-it-do>What does it do?</a><li><a class=link-body-emphasis href=#checking-the-result>Checking the result</a><li><a class=link-body-emphasis href=#wrapping-it-up>Wrapping it up</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/blog/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/blog/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a><li><a title="A Rusty frontend: Patternfly & Yew" class=link-body-emphasis href=/blog/2021/01/08/rusty-frontend-patternfly-yew/>A Rusty frontend: Patternfly & Yew</a><li><a title="OpenShift Update Graph Visualizer, lessons learned" class=link-body-emphasis href=/blog/2020/08/02/openshift-update-graph-visualizer-lessons-learned/>OpenShift Update Graph Visualizer, lessons learned</a><li><a title="Quarkus – Supersonic Subatomic IoT" class=link-body-emphasis href=/blog/2020/06/30/quarkus-supersonic-subatomic-iot/>Quarkus – Supersonic Subatomic IoT</a></ul></div></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src=dentrassi.de/js/bootstrap.bundle.min.js></script><script defer src=dentrassi.de/elasticlunr.min.js></script><script defer src=dentrassi.de/search_index.en.js></script><script defer src=dentrassi.de/js/search.js></script>