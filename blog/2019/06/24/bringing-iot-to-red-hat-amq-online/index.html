<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href=dentrassi.de/main.css rel=stylesheet><title>ctron's blog</title><link href=dentrassi.de/atom.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=dentrassi.de>ctron's blog</a><div class="d-flex ms-auto me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop="name headline">Bringing IoT to Red Hat AMQ Online</h1><div><ul class="de-c-post-meta list-inline text-muted"><li class=list-inline-item><span>7 minute read</span> <meta content=1223 itemprop=wordCount><li class=list-inline-item><span content=2019-06-24 itemprop=datePublished>24 June 2019</span></ul></div></section><hr><section class=de-article__body itemprop=articleBody><p><a rel="noopener nofollow noreferrer" href=https://access.redhat.com/documentation/en-us/red_hat_amq/7.2/html/amq_online_1.1_on_openshift_container_platform_release_notes/index target=_blank>Red Hat AMQ Online 1.1</a> was recently announced, and I am excited about it because it contains a tech preview of our Internet of Things <a rel="noopener nofollow noreferrer" href=https://access.redhat.com/documentation/en-us/red_hat_amq/7.2/html/amq_online_1.1_on_openshift_container_platform_release_notes/tech-preview-online#internet_of_things_iot_functionality target=_blank>(IoT) support</a>. AMQ Online is the “messaging as service solution” from Red Hat AMQ. Leveraging the work we did on <a rel="noopener nofollow noreferrer" href=https://www.eclipse.org/hono/ target=_blank>Eclipse Hono</a> allows us to integrate a <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/2018/07/25/scaling-iot-eclipse-hono/ target=_blank>scalable</a>, cloud-native IoT personality into this general-purpose messaging layer. And the whole reason why you need an IoT messaging layer is so you can focus on connecting your cloud-side application with the millions of devices that you have out there.</p><span id=continue-reading></span><p><em>This post was originally published on <a rel="noopener nofollow noreferrer" href=https://developers.redhat.com/blog/ target=_blank>Red Hat Developers</a>, the community to learn, code, and share faster. To read the original post, click <a rel="noopener nofollow noreferrer" href=https://developers.redhat.com/blog/2019/05/14/bringing-iot-to-red-hat-amq-online/ target=_blank>here</a>.</em><h2 id=what-is-eclipse-honotm>What is Eclipse Hono™?</h2><p>Eclipse Hono is an IoT abstraction layer. It defines APIs in order to build an IoT stack in the cloud, taking care of things like device credentials, protocols, and scalability. For some of those APIs, it comes with a ready-to-run implementation, such as the MQTT protocol adapter. For others, such as the device registry, it only defines the necessary API. The actual implementation must be provided to the system.<figure><p><img alt="Eclipse Hono IoT architecture overview" src=https://dentrassi.de/wp-content/uploads/hono-overview.svg><figcaption>Eclipse Hono overview</figcaption></figure><p>A key feature of Hono is that it normalizes the different IoT-specific protocols on <a rel="noopener nofollow noreferrer" href=http://www.amqp.org/specification/1.0/amqp-org-download target=_blank>AMQP 1.0</a>. This protocol is common on the data center side, and it is quite capable of handling the requirements on throughput and back-pressure. However, on the IoT devices side, other protocols might have more benefits for certain use cases. MQTT is a favorite for many people, as is plain HTTP due to its simplicity. LoRaWAN, CoAP, Sigfox, etc. all have their pros and cons. If you want to play in the world of IoT, you simply have to support them all. Even when it comes to custom protocols, Hono provides a software stack to easily implement your custom protocol.<h2 id=amq-online>AMQ Online</h2><p>Hono requires an AMQP 1.0 messaging backend. It requires a broker and a component called “router” (which doesn’t own messages but only forwards them to the correct receiver). Of course, it expects the AMQP layer to be as scalable as Hono itself. AMQ Online is a “self-service,” messaging solution for the cloud. So it makes sense to allow Hono to run on top of it. We had this deployment model for a while in Hono, allowing the use of <a rel="noopener nofollow noreferrer" href=https://enmasse.io/ target=_blank>EnMasse</a> (the upstream project of AMQ Online).<h2 id=self-service-iot>Self-service IoT</h2><p>In a world of Kubernetes and operators, the thing that you are actually looking for is more like this:<pre class=language-yaml data-lang=yaml style=background:#fafafa;color:#383a42><code class=language-yaml data-lang=yaml><span style=color:#e45649>kind</span><span>: </span><span style=color:#50a14f>IoTProject
</span><span> </span><span style=color:#e45649>apiVersion</span><span>: </span><span style=color:#50a14f>iot.enmasse.io/v1alpha1
</span><span> </span><span style=color:#e45649>metadata</span><span>:
</span><span>   </span><span style=color:#e45649>name</span><span>: </span><span style=color:#50a14f>iot
</span><span>   </span><span style=color:#e45649>namespace</span><span>: </span><span style=color:#50a14f>myapp
</span><span> </span><span style=color:#e45649>spec</span><span>:
</span><span>   </span><span style=color:#e45649>downstreamStrategy</span><span>:
</span><span>     </span><span style=color:#e45649>managedStrategy</span><span>:
</span><span>       </span><span style=color:#e45649>addressSpace</span><span>:
</span><span>         </span><span style=color:#e45649>name</span><span>: </span><span style=color:#50a14f>iot
</span><span>         </span><span style=color:#e45649>plan</span><span>: </span><span style=color:#50a14f>standard-unlimited
</span><span>       </span><span style=color:#e45649>addresses</span><span>:
</span><span>         </span><span style=color:#e45649>telemetry</span><span>:
</span><span>           </span><span style=color:#e45649>plan</span><span>: </span><span style=color:#50a14f>standard-small-anycast
</span><span>         </span><span style=color:#e45649>event</span><span>:
</span><span>           </span><span style=color:#e45649>plan</span><span>: </span><span style=color:#50a14f>standard-small-queue
</span><span>         </span><span style=color:#e45649>command</span><span>:
</span><span>           </span><span style=color:#e45649>plan</span><span>: </span><span style=color:#50a14f>standard-small-anycast
</span></code></pre><p>You simply define your IoT project, by creating a new custom resource using <code>kubectl create -f</code> and you are done. If you have the IoT operator of AMQ Online 1.1 deployed, then it will create the necessary address space for you, and set up the required addresses.<p>The IoT project will also automatically act as a Hono tenant. In this example, the Hono tenant would be <code>myapp.iot</code>, and so the full authentication ID of e.g. <code>sensor1</code> would be <code>sensor1@myapp.iot</code>. The IoT project also holds all the optional tenant configuration under the section <code>.spec.configuration</code>.<p>With the <a rel="noopener nofollow noreferrer" href=https://github.com/ctron/hat target=_blank>Hono admin tool,</a> you can quickly register a new device with your installation (the documentation will also tell you how to achieve the same with <code>curl</code>):<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#a0a1a7># register the new context once with 'hat'
</span><span style=color:#e45649>hat</span><span> context create myapp1</span><span style=color:#e45649> --default-tenant</span><span> myapp.iot https://$(</span><span style=color:#e45649>oc -n</span><span> messaging-infra get routes device-registry</span><span style=color:#e45649> --template</span><span style=color:#a626a4>=</span><span style=color:#50a14f>'{{ .spec.host }}'</span><span>)
</span><span>
</span><span style=color:#a0a1a7># register a new device and set credentials
</span><span style=color:#e45649>hat</span><span> reg create 4711
</span><span style=color:#e45649>hat</span><span> cred set-password sensor1 sha-512 hono-secret</span><span style=color:#e45649> --device</span><span> 4711
</span></code></pre><p>With that, you can simply use Hono as always. First, start the consumer:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#a0a1a7># from the hono/cli directory
</span><span style=color:#a626a4>export </span><span style=color:#e45649>MESSAGING_HOST</span><span style=color:#a626a4>=</span><span style=color:#50a14f>$(</span><span style=color:#e45649>oc -n</span><span style=color:#50a14f> myapp get addressspace iot</span><span style=color:#e45649> -o</span><span style=color:#50a14f> jsonpath={.status.endpointStatuses</span><span style=color:#a626a4>[?</span><span style=color:#50a14f>(@.name==</span><span style=color:#0997b3>\'</span><span style=color:#50a14f>messaging</span><span style=color:#0997b3>\'</span><span style=color:#50a14f>)</span><span style=color:#a626a4>]</span><span style=color:#50a14f>.externalHost})
</span><span style=color:#a626a4>export </span><span style=color:#e45649>MESSAGING_PORT</span><span style=color:#a626a4>=</span><span style=color:#50a14f>443
</span><span>
</span><span style=color:#e45649>mvn</span><span> spring-boot:run</span><span style=color:#e45649> -Drun</span><span>.arguments=--hono.client.host=$</span><span style=color:#e45649>MESSAGING_HOST</span><span>,--hono.client.port=$</span><span style=color:#e45649>MESSAGING_PORT</span><span>,--hono.client.username=consumer,--hono.client.password=foobar,--tenant.id=myapp.iot,--hono.client.trustStorePath=target/config/hono-demo-certs-jar/tls.crt,--message.type=telemetry
</span></code></pre><p>And then publish some data to the telemetry channel:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>curl -X</span><span> POST</span><span style=color:#e45649> -i -u</span><span> sensor1@myapp.iot:hono-secret</span><span style=color:#e45649> -H </span><span style=color:#50a14f>'Content-Type: application/json'</span><span style=color:#e45649> --data-binary </span><span style=color:#50a14f>'{"temp": 5}'</span><span> https://$(</span><span style=color:#e45649>oc -n</span><span> enmasse-infra get routes iot-http-adapter</span><span style=color:#e45649> --template</span><span style=color:#a626a4>=</span><span style=color:#50a14f>'{{ .spec.host }}'</span><span>)/telemetry
</span></code></pre><p>For more detailed instructions, see: <a rel="noopener nofollow noreferrer" href=https://access.redhat.com/documentation/en-us/red_hat_amq/7.2/html/evaluating_amq_online_on_openshift_container_platform/assembly-iot-messaging target=_blank>Getting Started with Internet of Things (IoT) on AMQ Online</a>.<h2 id=iot-integration>IoT integration</h2><p>As mentioned before, you don’t do IoT just for the fun of it (well, maybe at home, with a Raspberry Pi, Node.js, OpenHAB, and mosquitto). But when you want to connect millions of devices with your cloud backend, you want to start working with that data. Using Hono gives you a pretty simple start. Everything you need is an AMQP 1.0 connectivity. Assuming you use Apache Camel, pushing telemetry data towards a Kafka cluster is as easy as (also see <a rel="noopener nofollow noreferrer" href=https://github.com/ctron/hono-example-bridge target=_blank>ctron/hono-example-bridge</a>):<pre class=language-xml data-lang=xml style=background:#fafafa;color:#383a42><code class=language-xml data-lang=xml><span><</span><span style=color:#e45649>route </span><span style=color:#c18401>id</span><span>=</span><span style=color:#50a14f>"store"</span><span>>
</span><span>  <</span><span style=color:#e45649>from </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"amqp:telemetry/myapp.iot" </span><span>/>
</span><span>
</span><span>  <</span><span style=color:#e45649>setHeader </span><span style=color:#c18401>id</span><span>=</span><span style=color:#50a14f>"setKafkaKey" </span><span style=color:#c18401>headerName</span><span>=</span><span style=color:#50a14f>"kafka.KEY"</span><span>>
</span><span>    <</span><span style=color:#e45649>simple</span><span>>${header[device_id]}&LT/</span><span style=color:#e45649>simple</span><span>>
</span><span>  &LT/</span><span style=color:#e45649>setHeader</span><span>>
</span><span>
</span><span>  <</span><span style=color:#e45649>to </span><span style=color:#c18401>uri</span><span>=</span><span style=color:#50a14f>"kafka:telemetry?brokers={{kafka.brokers}}" </span><span>/>
</span><span>&LT/</span><span style=color:#e45649>route</span><span>>
</span></code></pre><p>Bringing together solutions like <a rel="noopener nofollow noreferrer" href=https://www.redhat.com/en/technologies/jboss-middleware/fuse target=_blank>Red Hat Fuse</a>, <a rel="noopener nofollow noreferrer" href=https://www.redhat.com/en/technologies/jboss-middleware/amq target=_blank>AMQ</a> and <a rel="noopener nofollow noreferrer" href=https://www.redhat.com/en/technologies/jboss-middleware/decision-manager target=_blank>Decision Manager</a> makes it a lot easier to give your custom logic in the data center (your value add‑on) access to the Internet of Things.<h2 id=what-s-next>What’s next?</h2><p>AMQ Online 1.1 is the first version to feature IoT as a tech preview. So, give it a try, play with it, but also keep in mind that it is a tech preview.<p>In the upstream project EnMasse, we are currently working on creating a scalable, general purpose device registry based on <a rel="noopener nofollow noreferrer" href=https://infinispan.org/ target=_blank>Infinispan</a>. Hono itself doesn’t bring a device registry, it only defines the APIs it requires. However, we think it makes sense to provide a scalable device registry, out of the box, to get you started. In AMQ Online, that would then be supported by using <a rel="noopener nofollow noreferrer" href=https://www.redhat.com/en/technologies/jboss-middleware/data-grid target=_blank>Red Hat Data Grid</a>.<p>In the next months, we hope to also see the release of Eclipse Hono 1.0 and graduate the project from the incubation phase. This is a big step for a project at Eclipse but also the right thing to do. Eclipse Hono is ready, and graduating the project means that we will pay even closer attention to APIs and stability. Still, new features like LoRaWAN, maybe Sigfox, and a proper HTTP API definition for the device registry, are already under development.<p>So, there are lots of new features and enhancements that we hope to bring into AMQ Online 1.2.</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#what-is-eclipse-honotm>What is Eclipse Hono™?</a><li><a class=link-body-emphasis href=#amq-online>AMQ Online</a><li><a class=link-body-emphasis href=#self-service-iot>Self-service IoT</a><li><a class=link-body-emphasis href=#iot-integration>IoT integration</a><li><a class=link-body-emphasis href=#what-s-next>What’s next?</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/blog/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/blog/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a><li><a title="A Rusty frontend: Patternfly & Yew" class=link-body-emphasis href=/blog/2021/01/08/rusty-frontend-patternfly-yew/>A Rusty frontend: Patternfly & Yew</a><li><a title="OpenShift Update Graph Visualizer, lessons learned" class=link-body-emphasis href=/blog/2020/08/02/openshift-update-graph-visualizer-lessons-learned/>OpenShift Update Graph Visualizer, lessons learned</a><li><a title="Quarkus – Supersonic Subatomic IoT" class=link-body-emphasis href=/blog/2020/06/30/quarkus-supersonic-subatomic-iot/>Quarkus – Supersonic Subatomic IoT</a></ul></div></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src=dentrassi.de/js/bootstrap.bundle.min.js></script><script defer src=dentrassi.de/elasticlunr.min.js></script><script defer src=dentrassi.de/search_index.en.js></script><script defer src=dentrassi.de/js/search.js></script>