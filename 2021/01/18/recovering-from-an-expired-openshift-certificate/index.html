<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href="https://staging.dentrassi.de/main.css?h=1bb5ac0ebcacce2b719e" rel=stylesheet><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var a="https://logs.dentrassi.de/";_paq.push(['setTrackerUrl',a+ 'matomo.php']);_paq.push(['setSiteId','1']);var b=document,c=b.createElement('script'),d=b.getElementsByTagName('script')[0];c.async=true;c.src=a+ 'matomo.js';d.parentNode.insertBefore(c,d)})()</script><link href=https://staging.dentrassi.de/2021/01/18/recovering-from-an-expired-openshift-certificate/ rel=canonical><meta content="A not-so-great way to start into a new week, is to figure out that the certificate of your API server expired on the weekend. Fixing and expired OpenShift certificate should be straight forward, but it wasn’t. Here is what happened, or you can directly scroll down for the solution.
" name=description><meta content=article property=og:type><meta content="ctron's blog" property=og:site_name><meta content="Recovering from an expired OpenShift certificate" property=og:title><meta content=https://staging.dentrassi.de/2021/01/18/recovering-from-an-expired-openshift-certificate property=og:url><meta content="A not-so-great way to start into a new week, is to figure out that the certificate of your API server expired on the weekend. Fixing and expired OpenShift certificate should be straight forward, but it wasn’t. Here is what happened, or you can directly scroll down for the solution.
" property=og:description><meta content="Jens Reimann" property=og:author_name><meta content=https://dentrassi.de property=og:author_url><meta content=summary name=twitter:card><meta content=@ctron name=twitter:site><meta content="Recovering from an expired OpenShift certificate" name=twitter:title><meta content="A not-so-great way to start into a new week, is to figure out that the certificate of your API server expired on the weekend. Fixing and expired OpenShift certificate should be straight forward, but it wasn’t. Here is what happened, or you can directly scroll down for the solution.
" name=twitter:description><meta content=OpenShift property=article:tag><title>Recovering from an expired OpenShift certificate – ctron's blog</title><link href=https://staging.dentrassi.de/rss.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=https://staging.dentrassi.de>ctron's blog</a><form class="de-c-search-form d-none d-lg-flex ms-auto me-3"><input placeholder="Search docs" aria-label=Search autocomplete=off class=form-control id=searchInput type=search><div class="shadow bg-white rounded" id=suggestions></div></form><div class="d-none d-md-flex ms-auto ms-lg-0 me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop=headline>Recovering from an expired OpenShift certificate</h1><div><div class="de-c-post-meta text-muted"><ul class=list-inline><li class=list-inline-item><span>5 minute read</span> <meta content=860 itemprop=wordCount> <span class=d-none itemprop=author itemscope itemtype=https://schema.org/Person> <a href=https://dentrassi.de itemprop=url> <span itemprop=name>Jens Reimann</span> </a> </span><li class=list-inline-item><span content=2021-01-18T12:29:21+01:00 itemprop=datePublished>18 January 2021</span><li class=list-inline-item><span><a class=link-secondary href=/categories/technical-stuff>Technical Stuff</a></span></ul><ul class=list-inline><li class=list-inline-item><a class=link-secondary href=https://staging.dentrassi.de/tags/openshift/>#openshift</a></ul></div></div></section><hr><section class=de-article__body itemprop=articleBody><p>A not-so-great way to start into a new week, is to figure out that the certificate of your API server expired on the weekend. Fixing and expired OpenShift certificate should be straight forward, but it wasn’t. Here is what happened, or you can directly scroll down for the solution.</p><span id=continue-reading></span><h2 id=the-setting>The setting</h2><p>I am running my own <a rel="noopener nofollow noreferrer" href=https://www.openshift.com/ target=_blank>OpenShift</a> cluster for a while now, playing with <a rel="noopener nofollow noreferrer" href=https://dentrassi.de/category/iot/ target=_blank>IoT stuff</a>, and using <a rel="noopener nofollow noreferrer" href=https://letsencrypt.org/ target=_blank>Let’s Encrypt</a> certificates to secure the API server endpoints and the application domain. Most of that is automated, only the certificate renewal is not. So every 60 days, I am refreshing the certificates, which gives me a buffer of 30 days, should something go wrong. And while I have that scripted as well, I need to manually trigger that.<p>So when you start a new week, try to log in an see the following output, you know that you forgot about something important:<pre style=background:#fafafa;color:#383a42><code><span>error: x509: certificate has expired or is not yet valid: current time 2021-01-18T11:21:55+01:00 is after 2021-01-17T09:35:54Z
</span></code></pre><p>Then again, I do recall refreshing the certificates at the end of 2020. So what went wrong?<h2 id=what-happened>What happened?</h2><p>I only found out about the root cause later, once I fixed the issue. However, it is an important piece of the puzzle, because my case was a bit different from most cases of an expired OpenShift certificate.<p>OpenShift allows you to manage the certificates using a custom resource, and has an operator to roll out those certificates. In a nutshell, you need to provide two <code>Secrets</code>, containing a signed certificate and key each. OpenShift will do the rest for you. One combination is for the API server, and the other one is for the application domain, the default ingress mechanism.<p>I did make a change to my script, and that introduced a bug. The result was that the API server certificates was renewed, however the application domain certificate was not.<h2 id=what-needed-to-be-done>What needed to be done?</h2><p>All that I would needed to do in order to fix this, was to update the <code>Secret</code> which contains the key/cert combination. Providing a newer, non-expired version, would trigger a re-rollout and all things would be back to normal.<p>But how you can update a <code>Secret</code> if you no longer have access to your cluster? <code>oc login</code> failed with the certificate error.<h2 id=why-not-skip-tls-validation>Why not skip TLS validation?</h2><p>True, the <code>oc</code> command, as well as the <code>kubectl</code> command, offer you to provide <code>--insecure-skip-tls-verify=true</code> and just skip TLS validation. And that would have worked, if the issue was with the API server certificate.<p>However, the situation here was different. I didn’t have a valid access token anymore. In order to get a new one, you simply do <code>oc login</code>. That didn’t work out, reporting the same X.509 certificate error. In the background, the <code>oc</code> commands tries to refresh the token, but not using the API server, but using an OAuth endpoint. Which is hosted on the standard ingress endpoints, and not the API server endpoints. Unfortunately, <code>--insecure-skip-tls-verify</code> only works for the API server endpoints. I would call that a bit inconsistent, but hey.<h2 id=other-cases-of-expired-openshift-certificates>Other cases of expired OpenShift certificates</h2><p>Searching on the internet for a solution, all kinds of “expired certificate” cases with Kubernetes showed up. Many of the on the control plane, but that wasn’t what I was looking for. Also some of the API server certificate fixes sounded rather invasive. I am glad I didn’t give any of them a try, as that might have actually caused more harm in the end.<p>Remember, all I needed was a way to replace some <code>Secrets</code>.<h2 id=the-solution>The solution</h2><p>After some debugging, I found the root cause, mentioned above. The API endpoint certificate was working, the OAuth one was expired. Making <code>oc login</code> fail, despite adding <code>--insecure-skip-tls-verify=true</code> to calls.<p>Fortunately, when creating an OpenShift cluster you will also get a cluster certificate, which you can use to access the API server as an admin user. You are supposed to keep this key/cert combination, for cases like this.<p>Setting the <code>KUBECONFIG</code> environment variable to the generated, original configuration gives you direct access to your cluster, without the need to log in:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#a626a4>export </span><span style=color:#e45649>KUBECONFIG</span><span style=color:#a626a4>=</span><span style=color:#50a14f>/home/me/cluster/installation/auth/kubeconfig
</span></code></pre><p>After that, I was automatically “logged in”, and could re-run my custom scripts for replacing the <code>Secrets</code> necessary to fix the expired OpenShift certificates. The operator rolled them out, and the cluster was operational again.<p>The actual commands for re-creating the ingress certificates might be different in your case, depending on your settings and environment. Here is what works for me:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>oc</span><span> delete secret</span><span style=color:#e45649> -n</span><span> openshift-ingress ingress-cert</span><span style=color:#e45649> --ignore-not-found</span><span style=color:#a626a4>=</span><span>true
</span><span style=color:#e45649>oc</span><span> create secret tls ingress-cert \
</span><span style=color:#e45649>  --cert</span><span style=color:#a626a4>=</span><span>certs/apps.full.pem \
</span><span style=color:#e45649>  --key</span><span style=color:#a626a4>=</span><span>certs/apps.key \
</span><span style=color:#e45649>  -n</span><span> openshift-ingress
</span><span style=color:#e45649>oc</span><span> patch ingresscontroller.operator default \
</span><span style=color:#e45649>  --type</span><span style=color:#a626a4>=</span><span>merge</span><span style=color:#e45649> -p </span><span>\
</span><span>  </span><span style=color:#50a14f>'{"spec":{"defaultCertificate": {"name": "ingress-cert"}}}' </span><span>\
</span><span style=color:#e45649>  -n</span><span> openshift-ingress-operator
</span></code></pre><h2 id=lessons-learned>Lessons learned</h2><p>Maybe this helps you, and saves you a few minutes. I might help me in the future :-)</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="d-flex d-md-none pb-3"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#the-setting>The setting</a><li><a class=link-body-emphasis href=#what-happened>What happened?</a><li><a class=link-body-emphasis href=#what-needed-to-be-done>What needed to be done?</a><li><a class=link-body-emphasis href=#why-not-skip-tls-validation>Why not skip TLS validation?</a><li><a class=link-body-emphasis href=#other-cases-of-expired-openshift-certificates>Other cases of expired OpenShift certificates</a><li><a class=link-body-emphasis href=#the-solution>The solution</a><li><a class=link-body-emphasis href=#lessons-learned>Lessons learned</a></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="Yew components for OpenID connect and OAuth2" class=link-body-emphasis href=/2023/10/22/yew-oauth2/>Yew components for OpenID connect and OAuth2</a><li><a title="trunk-ng, the fork of trunk" class=link-body-emphasis href=/2023/10/14/trunk-ng-the-fork-of-trunk/>trunk-ng, the fork of trunk</a><li><a title="A fresh start" class=link-body-emphasis href=/2023/10/03/a-fresh-start/>A fresh start</a><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a></ul></div></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Categories</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/categories>All</a> </span></h2><ul class=list-unstyled><li><a class=link-body-emphasis href=https://staging.dentrassi.de/categories/technical-stuff/>Technical Stuff</a></ul></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Tags</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/tags>All</a> </span></h2><a class=link-body-emphasis href=https://staging.dentrassi.de/tags/openshift/>#openshift</a></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=https://staging.dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=https://staging.dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=https://staging.dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=https://staging.dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src="https://staging.dentrassi.de/js/bootstrap.bundle.min.js?h=82f64f62bb03c1bc1824"></script><script src="https://staging.dentrassi.de/elasticlunr.min.js?h=4f648b9e42abdef9c436" defer></script><script src="https://staging.dentrassi.de/js/search.js?h=ed51a29cb343a0c8a535" defer></script><script>window.searchIndexLocation="https://staging.dentrassi.de/search_index.en.json?h=9bf355bddacfec00135d"</script>