<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=https://dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href="https://dentrassi.de/main.css?h=1bb5ac0ebcacce2b719e" rel=stylesheet><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var a="https://logs.dentrassi.de/";_paq.push(['setTrackerUrl',a+ 'matomo.php']);_paq.push(['setSiteId','1']);var b=document,c=b.createElement('script'),d=b.getElementsByTagName('script')[0];c.async=true;c.src=a+ 'matomo.js';d.parentNode.insertBefore(c,d)})()</script><meta content="Today I ran into a problem which could easily solved using a short WMI query. The problem was that the query must be executed within a Java UI application. Googling for a solution I came only up with either quite some ugly workarounds (like generating a VBScript fragment, forking off the VBScript runtime and parsing the result) or some full blown COM/DCOM interfaces (like J-Integra or J-Interop). Although I really like J-Interop (we are using it for DCOM when accessing OPC server in OpenSCADA Utgard) it has some drawbacks. For J-Interop every access (even local access) is a network based access. Since J-Interop only supports DCOM it is free of any platform specific code but required the machine to be accessible using “remoting” functionality (DCOM). Since I wanted to query the WMI from a UI application and I am sure that the WMI query will stay on the Win32 version of the application I was not keen on adding “remoting” as a requirement to the UI application.
" name=description><meta content=article property=og:type><meta content="ctron's blog" property=og:site_name><meta content="Access to WMI in Java using Eclipse SWT OLE integration" property=og:title><meta content=https://dentrassi.de/2011/02/04/access-to-wmi-in-java-using-eclipse-swt-ole-integration property=og:url><meta content="Today I ran into a problem which could easily solved using a short WMI query. The problem was that the query must be executed within a Java UI application. Googling for a solution I came only up with either quite some ugly workarounds (like generating a VBScript fragment, forking off the VBScript runtime and parsing the result) or some full blown COM/DCOM interfaces (like J-Integra or J-Interop). Although I really like J-Interop (we are using it for DCOM when accessing OPC server in OpenSCADA Utgard) it has some drawbacks. For J-Interop every access (even local access) is a network based access. Since J-Interop only supports DCOM it is free of any platform specific code but required the machine to be accessible using “remoting” functionality (DCOM). Since I wanted to query the WMI from a UI application and I am sure that the WMI query will stay on the Win32 version of the application I was not keen on adding “remoting” as a requirement to the UI application.
" property=og:description><meta content="Jens Reimann" property=og:author_name><meta content=https://dentrassi.de property=og:author_url><meta content=summary name=twitter:card><meta content=@ctron name=twitter:site><meta content="Access to WMI in Java using Eclipse SWT OLE integration" name=twitter:title><meta content="Today I ran into a problem which could easily solved using a short WMI query. The problem was that the query must be executed within a Java UI application. Googling for a solution I came only up with either quite some ugly workarounds (like generating a VBScript fragment, forking off the VBScript runtime and parsing the result) or some full blown COM/DCOM interfaces (like J-Integra or J-Interop). Although I really like J-Interop (we are using it for DCOM when accessing OPC server in OpenSCADA Utgard) it has some drawbacks. For J-Interop every access (even local access) is a network based access. Since J-Interop only supports DCOM it is free of any platform specific code but required the machine to be accessible using “remoting” functionality (DCOM). Since I wanted to query the WMI from a UI application and I am sure that the WMI query will stay on the Win32 version of the application I was not keen on adding “remoting” as a requirement to the UI application.
" name=twitter:description><meta content=Eclipse property=article:tag><meta content=Java property=article:tag><meta content=SWT property=article:tag><meta content=Windows property=article:tag><title>ctron's blog</title><link href=https://dentrassi.de/rss.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=https://dentrassi.de>ctron's blog</a><form class="de-c-search-form d-none d-lg-flex ms-auto me-3"><input placeholder="Search docs" aria-label=Search autocomplete=off class=form-control id=searchInput type=search><div class="shadow bg-white rounded" id=suggestions></div></form><div class="d-none d-md-flex ms-auto ms-lg-0 me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop=headline>Access to WMI in Java using Eclipse SWT OLE integration</h1><div><div class="de-c-post-meta text-muted"><ul class=list-inline><li class=list-inline-item><span>7 minute read</span> <meta content=1368 itemprop=wordCount> <span class=d-none itemprop=author itemscope itemtype=https://schema.org/Person> <a href=https://dentrassi.de itemprop=url> <span itemprop=name>Jens Reimann</span> </a> </span><li class=list-inline-item><span content=2011-02-04T17:58:44+01:00 itemprop=datePublished> 4 February 2011</span><li class=list-inline-item><span><a class=link-secondary href=/categories/development>Development</a></span></ul><ul class=list-inline><li class=list-inline-item><a class=link-secondary href=https://dentrassi.de/tags/eclipse/>#eclipse</a> <a class=link-secondary href=https://dentrassi.de/tags/java/>#java</a> <a class=link-secondary href=https://dentrassi.de/tags/swt/>#swt</a> <a class=link-secondary href=https://dentrassi.de/tags/windows/>#windows</a></ul></div></div></section><hr><section class=de-article__body itemprop=articleBody><p>Today I ran into a problem which could easily solved using a short WMI query. The problem was that the query must be executed within a Java UI application. Googling for a solution I came only up with either quite some ugly workarounds (like generating a VBScript fragment, forking off the VBScript runtime and parsing the result) or some full blown COM/DCOM interfaces (like J-Integra or J-Interop). Although I really like J-Interop (we are using it for DCOM when accessing OPC server in OpenSCADA Utgard) it has some drawbacks. For J-Interop every access (even local access) is a network based access. Since J-Interop only supports DCOM it is free of any platform specific code but required the machine to be accessible using “remoting” functionality (DCOM). Since I wanted to query the WMI from a UI application and I am sure that the WMI query will stay on the Win32 version of the application I was not keen on adding “remoting” as a requirement to the UI application.</p><span id=continue-reading></span><p>After some digging I remembered that SWT brings an OLE interface which provides direct COM access. So I started poking around and finally come up with a solution that works quite well.<p><img alt src=/wp-content/uploads/wmisample.png title=wmisample> For the impatient: The full source code is available from github <a rel="noopener nofollow noreferrer" href=https://github.com/ctron/wmisample target=_blank>https://github.com/ctron/wmisample</a> and the screenshot is here.<p>The solution requires: win32 or win64, SWT and some classes from the SWT internal namespace. The latter is a catch that does not hurt too much.<p>First one needs a SWbemServices object which is obtained by asking the SWbemLocator to create one:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#c18401>OleAutomation</span><span> automation </span><span style=color:#a626a4>= new </span><span style=color:#c18401>OleAutomation</span><span>(</span><span style=color:#50a14f>"WbemScripting.SWbemLocator"</span><span>);
</span><span style=color:#c18401>Variant</span><span> service </span><span style=color:#a626a4>=</span><span> automation.</span><span style=color:#e45649>invoke</span><span>(</span><span style=color:#c18401>Helper</span><span>.</span><span style=color:#e45649>getId</span><span>(automation, </span><span style=color:#50a14f>"ConnectServer"</span><span>));
</span></code></pre><p>The variant will hold a <code>VT_DISPATCH</code> value which references the SWbemServices instance. Instead of calling the <q>ConnectServer</q> method with any parameters one can also call with full remote server support (see <a href="http://msdn.microsoft.com/en-us/library/aa393720%28v=VS.85%29.aspx" rel="noopener nofollow noreferrer" target=_blank>MSDN</a>).<p>The next, and rather easy, step is to execute the query:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#c18401>OleAutomation</span><span> serviceAutomation </span><span style=color:#a626a4>=</span><span> service.</span><span style=color:#e45649>getAutomation</span><span>();
</span><span>
</span><span style=color:#c18401>Variant</span><span> resultList </span><span style=color:#a626a4>=</span><span> serviceAutomation.</span><span style=color:#e45649>invoke</span><span>(
</span><span>   </span><span style=color:#c18401>Helper</span><span>.</span><span style=color:#e45649>getId</span><span>(serviceAutomation, </span><span style=color:#50a14f>"ExecQuery"</span><span>),
</span><span>   </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>[] {
</span><span>      </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>(query),
</span><span>      </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>(</span><span style=color:#50a14f>"WQL"</span><span>),
</span><span>      </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>(</span><span style=color:#c18401>32</span><span>) });
</span></code></pre><p>The Helper.getId method fetches the dispatch id (function number) from the name of the function. So instead of calling a function by name you call it by id and look up the id by the name first:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>public static int </span><span style=color:#e45649>getId</span><span>(</span><span style=color:#c18401>OleAutomation</span><span> auto, </span><span style=color:#c18401>String</span><span> name) {
</span><span>   </span><span style=color:#a626a4>int</span><span> result[] </span><span style=color:#a626a4>=</span><span> auto.</span><span style=color:#e45649>getIDsOfNames</span><span>(</span><span style=color:#a626a4>new </span><span style=color:#c18401>String</span><span>[] { name });
</span><span>   </span><span style=color:#a626a4>if </span><span>(result </span><span style=color:#a626a4>== </span><span style=color:#c18401>null </span><span style=color:#a626a4>||</span><span> result.length </span><span style=color:#a626a4>< </span><span style=color:#c18401>1</span><span>) {
</span><span>      </span><span style=color:#a626a4>throw new </span><span style=color:#c18401>RuntimeException</span><span>(</span><span style=color:#c18401>String</span><span>.</span><span style=color:#e45649>format</span><span>(
</span><span>         </span><span style=color:#50a14f>"Object does not support '%s'"</span><span>, name));
</span><span>   }
</span><span>   </span><span style=color:#a626a4>return</span><span> result[</span><span style=color:#c18401>0</span><span>];
</span><span>}
</span></code></pre><p>The result of the <q>ExecQuery</q> call is an object of the type <tt>SWbemObjectSet</tt>. The strange thing with this object is, that <a href="http://msdn.microsoft.com/en-us/library/aa393762%28v=VS.85%29.aspx" rel="noopener nofollow noreferrer" target=_blank>by documentation</a> it only has an <q>Item</q> method which requires that you actually don’t want to know and provide. While all examples you find which that the result is directly used in VB <q>for each</q> constructs. But the object also provides an undocumented (still valid) <q>_NewEnum</q> method which is used by e.g. VB by default for <q>for each</q> loops. So one can call this method explicitly and iterate over the result.<p>The problem here is, that the result to the <q>_NewEnum</q> call is a VT_UNKNOWN variant since the result is a COM object without support for IDispatch. So one has to play plain COM games and QueryInterface for IEnumVARIANT and iterate using <q>Next</q>.<p>And here comes the part were one needs to use SWT internal methods, since this requires allocating memory and performing pointer stuff. So be warned, from here on your are actually calling operating system memory allocating functions that may: a) crash your application when used improperly (like it does when you use C or C++) and b) produce memory leaks that are not covered by the Java VM but by direct calls to <q>alloc</q> calls in the OS.<p>In order to separate this stuff from the rest of the classes it all went into the Helper class, providing an <q>forEachVariant</q> method using a visitor interface:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>public static interface </span><span style=color:#c18401>VariantVisitor </span><span>{
</span><span>  </span><span style=color:#a626a4>public void </span><span style=color:#0184bc>visit</span><span>(</span><span style=color:#c18401>Variant </span><span style=color:#e45649>variant</span><span>);
</span><span>}
</span></code></pre><p>The method first gets the <q>enum</q> using the property (not method) <q>_NewEnum</q> which returns a variant of type VT_UNKNOWN:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#c18401>Variant</span><span> enumObject </span><span style=color:#a626a4>=</span><span> enumerableAuto.</span><span style=color:#e45649>getProperty</span><span>(
</span><span>  </span><span style=color:#c18401>Helper</span><span>.</span><span style=color:#e45649>getId</span><span>(enumerableAuto, </span><span style=color:#50a14f>"_NewEnum"</span><span>)
</span><span>);
</span></code></pre><p>Now one needs to QueryInterface to get the IEnumVARIANT interface for the unknown:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>long </span><span style=color:#a0a1a7>/* int */</span><span style=color:#a626a4>[]</span><span> ppvObject </span><span style=color:#a626a4>= new long </span><span style=color:#a0a1a7>/* int */</span><span>[</span><span style=color:#c18401>1</span><span>];
</span><span style=color:#a626a4>int</span><span> rc </span><span style=color:#a626a4>=</span><span> enumObject.</span><span style=color:#e45649>getUnknown</span><span>().</span><span style=color:#e45649>QueryInterface</span><span>(</span><span style=color:#c18401>COM</span><span>.</span><span style=color:#c18401>IIDIEnumVARIANT</span><span>, ppvObject);
</span><span style=color:#a626a4>if </span><span>(rc </span><span style=color:#a626a4>!= </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#c18401>S_OK</span><span>)
</span><span>  </span><span style=color:#a626a4>return</span><span> rc; </span><span style=color:#a0a1a7>// in case of error
</span></code></pre><p>Looks actually like call in C. The result will be a pointer to a IEnumVARIANT in ppvObject. You should also be aware of the fact that QueryInterface also performs as an AddRef, so you have to perform one Release call when you are done in order to decrease the usage count on the instance.<p>Next one can pass the pointer to the instance to an instance of IEnumVARIANT (which is also from SWT internal) and already provides mapping to the function calls Reset, Next, Release.<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#c18401>IEnumVARIANT</span><span> enumVariant </span><span style=color:#a626a4>= new </span><span style=color:#c18401>IEnumVARIANT</span><span>(ppvObject[</span><span style=color:#c18401>0</span><span>]);
</span><span>enumVariant.</span><span style=color:#e45649>Reset</span><span>();
</span></code></pre><p>And now comes the <q>fun</q> part of the whole thing. Allocating memory and iterating over the enumeration:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>int[]</span><span> pceltFetched </span><span style=color:#a626a4>= new int</span><span>[</span><span style=color:#c18401>1</span><span>];
</span><span style=color:#a626a4>long</span><span> rgelt </span><span style=color:#a626a4>= </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#e45649>GlobalAlloc</span><span>(</span><span style=color:#c18401>OS</span><span>.</span><span style=color:#c18401>GMEM_FIXED </span><span style=color:#a626a4>| </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#c18401>GMEM_ZEROINIT</span><span>,</span><span style=color:#c18401>Variant</span><span>.sizeof);
</span><span>
</span><span style=color:#a626a4>try </span><span>{
</span><span>  </span><span style=color:#a626a4>while </span><span>(enumVariant.</span><span style=color:#e45649>Next</span><span>(</span><span style=color:#c18401>1</span><span>, rgelt, pceltFetched) </span><span style=color:#a626a4>== </span><span style=color:#c18401>OLE</span><span>.</span><span style=color:#c18401>S_OK
</span><span>    </span><span style=color:#a626a4>&&</span><span> pceltFetched[</span><span style=color:#c18401>0</span><span>] </span><span style=color:#a626a4>== </span><span style=color:#c18401>1</span><span>) {
</span><span>      </span><span style=color:#c18401>Variant</span><span> v </span><span style=color:#a626a4>= </span><span style=color:#c18401>Variant</span><span>.</span><span style=color:#e45649>win32_new</span><span>(rgelt);
</span><span>      variantVisitor.</span><span style=color:#e45649>visit</span><span>(v);
</span><span>   }
</span><span>} </span><span style=color:#a626a4>finally </span><span>{
</span><span>    </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#e45649>GlobalFree</span><span>(rgelt);
</span><span>}
</span></code></pre><p>First a new Variant structure is allocated (again, this is OS memory allocation, not JVM!). Next the while loop iterates over the enumeration using Next calls and passes the variants to the visitor interface. The try-finally block ensures that when something goes wrong, at least the memory is freed in order to prevent memory leaks.<p>Actually is was asking myself why this IEnumVARIANT implementation does not perform the full magic and provides a way to access enums without using internal stuff. But I guess the SWT team has not too much interest in working on OLE/COM stuff and likes to keep things as minimalistic as possible.<p>As last step the while executeQuery method iterates over the <q>SWbemObjectSet</q> enumeration which returns Variants (<code>VT_DISPATCH</code>) pointing to instances of <q>SWbemObject</q>. They again have a property <q>Properties_</q> that, which again is an enumeration of <q>Name</q> and <q>Value</q> pairs. The one needs to iterate again in order to request all properties.<p>it was quite interesting to see what is possible with Eclipse SWT and quite annoying to dig through incomplete COM documentation. But in the end it worked :)<p>Don’t forget to check the full source code at github: <a rel="noopener nofollow noreferrer" href=https://github.com/ctron/wmisample target=_blank>https://github.com/ctron/wmisample</a><p>Just clone (aka check out) the source:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>git</span><span> clone git://github.com/ctron/wmisample.git wmisample.git
</span></code></pre><p>If you don’t like to use git, you can also use the “Downloads” button on github and download a ZIP instead.<p>The full forEach method is:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>public static int </span><span style=color:#e45649>forEachVariant</span><span>(</span><span style=color:#c18401>Variant</span><span> enumerable, </span><span style=color:#c18401>VariantVisitor</span><span> variantVisitor) {
</span><span>    </span><span style=color:#c18401>OleAutomation</span><span> enumerableAuto </span><span style=color:#a626a4>=</span><span> enumerable.</span><span style=color:#e45649>getAutomation</span><span>();
</span><span>
</span><span>    </span><span style=color:#a626a4>try </span><span>{
</span><span>        </span><span style=color:#c18401>Variant</span><span> enumObject </span><span style=color:#a626a4>=</span><span> enumerableAuto.</span><span style=color:#e45649>getProperty</span><span>(</span><span style=color:#c18401>Helper</span><span>.</span><span style=color:#e45649>getId</span><span>(
</span><span>           enumerableAuto, </span><span style=color:#50a14f>"_NewEnum"</span><span>));
</span><span>
</span><span>        </span><span style=color:#a626a4>long </span><span style=color:#a0a1a7>/* int */</span><span style=color:#a626a4>[]</span><span> ppvObject </span><span style=color:#a626a4>= new long </span><span style=color:#a0a1a7>/* int */</span><span>[</span><span style=color:#c18401>1</span><span>];
</span><span>        </span><span style=color:#a626a4>int</span><span> rc </span><span style=color:#a626a4>=</span><span> enumObject.</span><span style=color:#e45649>getUnknown</span><span>().</span><span style=color:#e45649>QueryInterface</span><span>(
</span><span>            </span><span style=color:#c18401>COM</span><span>.</span><span style=color:#c18401>IIDIEnumVARIANT</span><span>, ppvObject);
</span><span>
</span><span>        </span><span style=color:#a626a4>if </span><span>(rc </span><span style=color:#a626a4>!= </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#c18401>S_OK</span><span>)
</span><span>            </span><span style=color:#a626a4>return</span><span> rc;
</span><span>
</span><span>        </span><span style=color:#c18401>IEnumVARIANT</span><span> enumVariant </span><span style=color:#a626a4>= new </span><span style=color:#c18401>IEnumVARIANT</span><span>(ppvObject[</span><span style=color:#c18401>0</span><span>]);
</span><span>
</span><span>        </span><span style=color:#a626a4>try </span><span>{
</span><span>            enumVariant.</span><span style=color:#e45649>Reset</span><span>();
</span><span>
</span><span>            </span><span style=color:#a626a4>int[]</span><span> pceltFetched </span><span style=color:#a626a4>= new int</span><span>[</span><span style=color:#c18401>1</span><span>];
</span><span>
</span><span>            </span><span style=color:#a626a4>long</span><span> rgelt </span><span style=color:#a626a4>= </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#e45649>GlobalAlloc</span><span>(</span><span style=color:#c18401>OS</span><span>.</span><span style=color:#c18401>GMEM_FIXED </span><span style=color:#a626a4>| </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#c18401>GMEM_ZEROINIT</span><span>,
</span><span>                    </span><span style=color:#c18401>Variant</span><span>.sizeof);
</span><span>
</span><span>            </span><span style=color:#a626a4>try </span><span>{
</span><span>                </span><span style=color:#a626a4>while </span><span>(enumVariant.</span><span style=color:#e45649>Next</span><span>(</span><span style=color:#c18401>1</span><span>, rgelt, pceltFetched) </span><span style=color:#a626a4>== </span><span style=color:#c18401>OLE</span><span>.</span><span style=color:#c18401>S_OK
</span><span>                        </span><span style=color:#a626a4>&&</span><span> pceltFetched[</span><span style=color:#c18401>0</span><span>] </span><span style=color:#a626a4>== </span><span style=color:#c18401>1</span><span>) {
</span><span>                    </span><span style=color:#c18401>Variant</span><span> v </span><span style=color:#a626a4>= </span><span style=color:#c18401>Variant</span><span>.</span><span style=color:#e45649>win32_new</span><span>(rgelt);
</span><span>                    variantVisitor.</span><span style=color:#e45649>visit</span><span>(v);
</span><span>                }
</span><span>            } </span><span style=color:#a626a4>finally </span><span>{
</span><span>                </span><span style=color:#c18401>OS</span><span>.</span><span style=color:#e45649>GlobalFree</span><span>(rgelt);
</span><span>            }
</span><span>        } </span><span style=color:#a626a4>finally </span><span>{
</span><span>            enumVariant.</span><span style=color:#e45649>Release</span><span>();
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#a626a4>return </span><span style=color:#c18401>OLE</span><span>.</span><span style=color:#c18401>S_OK</span><span>;
</span><span>
</span><span>    } </span><span style=color:#a626a4>finally </span><span>{
</span><span>        enumerableAuto.</span><span style=color:#e45649>dispose</span><span>();
</span><span>    }
</span><span>}
</span></code></pre><p>And the full query logic method is:<pre class=language-java data-lang=java style=background:#fafafa;color:#383a42><code class=language-java data-lang=java><span style=color:#a626a4>public </span><span style=color:#c18401>List</span><span><</span><span style=color:#c18401>WMIObjectInformation</span><span>> </span><span style=color:#e45649>executeQuery</span><span>(</span><span style=color:#c18401>String</span><span> query) {
</span><span>    </span><span style=color:#c18401>OleAutomation</span><span> serviceAutomation </span><span style=color:#a626a4>=</span><span> service.</span><span style=color:#e45649>getAutomation</span><span>();
</span><span>    </span><span style=color:#a626a4>try </span><span>{
</span><span>        </span><span style=color:#a626a4>final </span><span style=color:#c18401>List</span><span><</span><span style=color:#c18401>WMIObjectInformation</span><span>> result </span><span style=color:#a626a4>= new </span><span style=color:#c18401>LinkedList</span><span><</span><span style=color:#c18401>WMIObjectInformation</span><span>>();
</span><span>
</span><span>        </span><span style=color:#c18401>Variant</span><span> resultList </span><span style=color:#a626a4>=</span><span> serviceAutomation.</span><span style=color:#e45649>invoke</span><span>(
</span><span>                </span><span style=color:#c18401>Helper</span><span>.</span><span style=color:#e45649>getId</span><span>(serviceAutomation, </span><span style=color:#50a14f>"ExecQuery"</span><span>),
</span><span>                </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>[] { </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>(query), </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>(</span><span style=color:#50a14f>"WQL"</span><span>),
</span><span>                        </span><span style=color:#a626a4>new </span><span style=color:#c18401>Variant</span><span>(</span><span style=color:#c18401>32</span><span>) });
</span><span>
</span><span>        </span><span style=color:#a626a4>if </span><span>(resultList </span><span style=color:#a626a4>== </span><span style=color:#c18401>null</span><span>) {
</span><span>            </span><span style=color:#a626a4>throw new </span><span style=color:#c18401>RuntimeException</span><span>(serviceAutomation.</span><span style=color:#e45649>getLastError</span><span>());
</span><span>        }
</span><span>
</span><span>        </span><span style=color:#c18401>Helper</span><span>.</span><span style=color:#e45649>forEachVariant</span><span>(resultList, </span><span style=color:#a626a4>new </span><span style=color:#c18401>VariantVisitor</span><span>() </span><span style=color:#c18401>{
</span><span style=color:#c18401>
</span><span style=color:#c18401>            @</span><span style=color:#e45649>Override
</span><span style=color:#c18401>            </span><span style=color:#a626a4>public void </span><span style=color:#0184bc>visit</span><span style=color:#c18401>(Variant </span><span style=color:#e45649>variant</span><span style=color:#c18401>) {
</span><span style=color:#c18401>
</span><span style=color:#c18401>                </span><span style=color:#a626a4>final </span><span style=color:#c18401>Map&LTString, Object> params </span><span style=color:#a626a4>= new </span><span style=color:#c18401>HashMap&LTString, Object>();
</span><span style=color:#c18401>
</span><span style=color:#c18401>                Variant properties </span><span style=color:#a626a4>= </span><span style=color:#c18401>Helper.</span><span style=color:#e45649>getParameter</span><span style=color:#c18401>(variant,
</span><span style=color:#c18401>                        </span><span style=color:#50a14f>"Properties_"</span><span style=color:#c18401>);
</span><span style=color:#c18401>
</span><span style=color:#c18401>                Helper.</span><span style=color:#e45649>forEachVariant</span><span style=color:#c18401>(properties, </span><span style=color:#a626a4>new </span><span style=color:#c18401>VariantVisitor() {
</span><span style=color:#c18401>
</span><span style=color:#c18401>                    @</span><span style=color:#e45649>Override
</span><span style=color:#c18401>                    </span><span style=color:#a626a4>public void </span><span style=color:#0184bc>visit</span><span style=color:#c18401>(Variant </span><span style=color:#e45649>variant</span><span style=color:#c18401>) {
</span><span style=color:#c18401>
</span><span style=color:#c18401>                        Variant name </span><span style=color:#a626a4>= </span><span style=color:#c18401>Helper.</span><span style=color:#e45649>getParameter</span><span style=color:#c18401>(variant, </span><span style=color:#50a14f>"Name"</span><span style=color:#c18401>);
</span><span style=color:#c18401>                        Variant value </span><span style=color:#a626a4>= </span><span style=color:#c18401>Helper.</span><span style=color:#e45649>getParameter</span><span style=color:#c18401>(variant,
</span><span style=color:#c18401>                                </span><span style=color:#50a14f>"Value"</span><span style=color:#c18401>);
</span><span style=color:#c18401>                        Object objectValue </span><span style=color:#a626a4>= </span><span style=color:#c18401>Helper.</span><span style=color:#e45649>convertVariant</span><span style=color:#c18401>(value);
</span><span style=color:#c18401>
</span><span style=color:#c18401>                        params.</span><span style=color:#e45649>put</span><span style=color:#c18401>(name.</span><span style=color:#e45649>getString</span><span style=color:#c18401>(), objectValue);
</span><span style=color:#c18401>                    }
</span><span style=color:#c18401>                });
</span><span style=color:#c18401>
</span><span style=color:#c18401>                result.</span><span style=color:#e45649>add</span><span style=color:#c18401>(</span><span style=color:#a626a4>new </span><span style=color:#c18401>WMIObjectInformation(Helper.</span><span style=color:#e45649>getParameter</span><span style=color:#c18401>(
</span><span style=color:#c18401>                        Helper.</span><span style=color:#e45649>getParameter</span><span style=color:#c18401>(variant, </span><span style=color:#50a14f>"Path_"</span><span style=color:#c18401>), </span><span style=color:#50a14f>"Path"</span><span style=color:#c18401>)
</span><span style=color:#c18401>                        .</span><span style=color:#e45649>getString</span><span style=color:#c18401>(), params));
</span><span style=color:#c18401>            }
</span><span style=color:#c18401>        }</span><span>);
</span><span>
</span><span>        </span><span style=color:#a626a4>return</span><span> result;
</span><span>    } </span><span style=color:#a626a4>finally </span><span>{
</span><span>        serviceAutomation.</span><span style=color:#e45649>dispose</span><span>();
</span><span>    }
</span><span>}
</span></code></pre></section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="d-flex d-md-none pb-3"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=https://dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="Yew components for OpenID connect and OAuth2" class=link-body-emphasis href=/2023/10/22/yew-oauth2/>Yew components for OpenID connect and OAuth2</a><li><a title="trunk-ng, the fork of trunk" class=link-body-emphasis href=/2023/10/14/trunk-ng-the-fork-of-trunk/>trunk-ng, the fork of trunk</a><li><a title="A fresh start" class=link-body-emphasis href=/2023/10/03/a-fresh-start/>A fresh start</a><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a></ul></div></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Categories</span> <span class=de-c-title__action> <a href=https://dentrassi.de/categories>All</a> </span></h2><ul class=list-unstyled><li><a class=link-body-emphasis href=https://dentrassi.de/categories/development/>Development</a></ul></div><div class="de-c-toc mb-4"><h2 class=d-flex><span>Tags</span> <span class=de-c-title__action> <a href=https://dentrassi.de/tags>All</a> </span></h2><a class=link-body-emphasis href=https://dentrassi.de/tags/eclipse/>#eclipse</a><a class=link-body-emphasis href=https://dentrassi.de/tags/java/>#java</a><a class=link-body-emphasis href=https://dentrassi.de/tags/swt/>#swt</a><a class=link-body-emphasis href=https://dentrassi.de/tags/windows/>#windows</a></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=https://dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=https://dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=https://dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=https://dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src="https://dentrassi.de/js/bootstrap.bundle.min.js?h=82f64f62bb03c1bc1824"></script><script src="https://dentrassi.de/elasticlunr.min.js?h=4f648b9e42abdef9c436" defer></script><script src="https://dentrassi.de/js/search.js?h=ed51a29cb343a0c8a535" defer></script><script>window.searchIndexLocation="https://dentrassi.de/search_index.en.json?h=6805ae138616e25d38b0"</script>