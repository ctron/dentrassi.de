<!doctype html><html lang=en-US><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/jost-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/noto-sans-latin-700-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-400-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-500-normal.woff2 rel=preload type=font/woff2><link as=font crossorigin href=https://staging.dentrassi.de/files/source-code-pro-latin-700-normal.woff2 rel=preload type=font/woff2><link href="https://staging.dentrassi.de/main.css?h=12d0957c36c254464d7f" rel=stylesheet><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var a="https://logs.dentrassi.de/";_paq.push(['setTrackerUrl',a+ 'matomo.php']);_paq.push(['setSiteId','1']);var b=document,c=b.createElement('script'),d=b.getElementsByTagName('script')[0];c.async=true;c.src=a+ 'matomo.js';d.parentNode.insertBefore(c,d)})()</script><meta content="The mission: “save some bucks by using a free PBX using a cheap isdn card”. Don’t try! Buy something working in the first place. But if you have to, here is one example how it can be done. There are, for sure, many others!
" name=description><meta content=article property=og:type><meta content="ctron's blog" property=og:site_name><meta content="Build your own SIP trunk with Asterisk and mISDN" property=og:title><meta content=https://staging.dentrassi.de/2013/01/22/build-your-own-sip-trunk-with-asterisk-and-misdn property=og:url><meta content="The mission: “save some bucks by using a free PBX using a cheap isdn card”. Don’t try! Buy something working in the first place. But if you have to, here is one example how it can be done. There are, for sure, many others!
" property=og:description><meta content="Jens Reimann" property=og:author_name><meta content=https://dentrassi.de property=og:author_url><meta content=summary name=twitter:card><meta content=@ctron name=twitter:site><meta content="Build your own SIP trunk with Asterisk and mISDN" name=twitter:title><meta content="The mission: “save some bucks by using a free PBX using a cheap isdn card”. Don’t try! Buy something working in the first place. But if you have to, here is one example how it can be done. There are, for sure, many others!
" name=twitter:description><title>ctron's blog</title><link href=https://staging.dentrassi.de/rss.xml rel=alternate title=RSS type=application/rss+xml><body data-bs-spy=scroll data-bs-target=#toc tabindex=0><nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary"><div class=container><a class=navbar-brand href=https://staging.dentrassi.de>ctron's blog</a><form class="de-c-search-form d-none d-lg-flex ms-auto me-3"><input placeholder="Search docs" aria-label=Search autocomplete=off class=form-control id=searchInput type=search><div class="shadow bg-white rounded" id=suggestions></div></form><div class="d-none d-md-flex ms-auto ms-lg-0 me-4 me-lg-0"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><button aria-label="Toggle navigation" aria-controls=rightSidebox aria-expanded=false class=navbar-toggler data-bs-target=#rightSidebox data-bs-toggle=collapse type=button><span class=navbar-toggler-icon></span></button></div></nav><div class="de-layout container"><div class="row d-flex align-items-start"><aside class="col-lg-2 order-last order-lg-0 sticky-lg-top mt-4 mt-lg-5"><div class="de-sidebox de-m-left"><div class=mb-4><h2>More</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/pages/about/>About</a><li><a class=link-body-emphasis href=/pages/pgp-key/>PGP Key</a><li><a class=link-body-emphasis href=/pages/attic/>Attic</a></ul></div><div class=mb-4><h2>Projects</h2><ul class=list-unstyled><li><a class=link-body-emphasis href=/projects/patternfly-yew/>PatternFly Yew</a><li><a class=link-body-emphasis href=/projects/yew-oauth2/>Yew OAuth2</a><li><a class=link-body-emphasis href=/projects/rpm-builder/>Maven RPM Builder</a><li><a class=link-body-emphasis href=/projects/drogue-iot/>Drogue IoT</a><li><a class=link-body-emphasis href=/projects/openshift-update-graph/>OpenShift Update Graph</a><li><a class=link-body-emphasis href=/projects/ecliipse-iot-packages/>Eclipse IoT Packages</a></ul></div></div></aside><main class="col-12 col-lg-7 px-lg-5 mt-3 mt-lg-4"><article class=de-article itemscope itemtype=http://schema.org/BlogPosting><div><section class=de-article__header><h1 itemprop="name headline">Build your own SIP trunk with Asterisk and mISDN</h1><div><ul class="de-c-post-meta list-inline text-muted"><li class=list-inline-item><span>10 minute read</span> <meta content=1911 itemprop=wordCount> <span class=d-none itemprop=author itemscope itemtype=https://schema.org/Person> <a href=https://dentrassi.de itemprop=url> <span itemprop=name>Jens Reimann</span> </a> </span><li class=list-inline-item><span content=2013-01-22 itemprop=datePublished>22 January 2013</span></ul></div></section><hr><section class=de-article__body itemprop=articleBody><p>The mission: “save some bucks by using a free PBX using a cheap isdn card”. Don’t try! Buy something working in the first place. But if you have to, here is one example how it can be done. There are, for sure, many others!</p><span id=continue-reading></span><p>The idea was to replace <a rel="noopener nofollow noreferrer" href=http://trixbox.org/ target=_blank title=trixbox>trixbox</a> using an AVM Fritz!PCI card with something more up to date and not that buggy. FreePBX Distro kicked itself out because of the issues with mISDN. Elastix brought in mISDN support but still failed in configuring it. Since the setup was for only 3 users for now and the idea was to later buy something more professional (I really hope it comes to this point), I used <a rel="noopener nofollow noreferrer" title="Starface free" href=http://www.starface.de/en/Produkte/softswitch/starface-free.php target=_blank>Starface free</a>. It has 4 users and 10 extensions for free. Yet the free version only allows using SIP providers. Also it was not possible to buy a <a href="http://www.patton.com/products/product_detail.asp?id=452" rel="noopener nofollow noreferrer" target=_blank>Patton SmartNode 4120</a> at the moment, which I still hope to get somewhere in the future. So I needed to build our own SIP trunk since the provider used (M-NET) does not provide SIP trunks as a product.<p>Everything is done as user <code>root</code> unless noted otherwise.<h2 id=misdn-gateway-setup>mISDN + gateway setup</h2><ul><li><p>Install a fresh centos 5 (5.9). You can use the netinstall version since you need practically nothing.</p><li><p>Be sure to update: yum update</p><li><p>add the elastix repository: elastix, epel</p> <p>create file <code>/etc/yum.repos.d/epel.repo</code></p> <pre style=background:#fafafa;color:#383a42><code><span>[epel]
</span><span>name=Extra Packages for Enterprise Linux 5 - $basearch
</span><span>#baseurl=http://download.fedoraproject.org/pub/epel/5/$basearch
</span><span>mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-5&arch=$basearch
</span><span>failovermethod=priority
</span><span>enabled=1
</span><span>gpgcheck=1
</span><span>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
</span><span>
</span><span>[epel-debuginfo]
</span><span>name=Extra Packages for Enterprise Linux 5 - $basearch - Debug
</span><span>#baseurl=http://download.fedoraproject.org/pub/epel/5/$basearch/debug
</span><span>mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-debug-5&arch=$basearch
</span><span>failovermethod=priority
</span><span>enabled=0
</span><span>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
</span><span>gpgcheck=1
</span><span>
</span><span>[epel-source]
</span><span>name=Extra Packages for Enterprise Linux 5 - $basearch - Source
</span><span>#baseurl=http://download.fedoraproject.org/pub/epel/5/SRPMS
</span><span>mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-source-5&arch=$basearch
</span><span>failovermethod=priority
</span><span>enabled=0
</span><span>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL
</span><span>gpgcheck=1
</span><span>
</span></code></pre> <p>create file <code>/etc/yum.repos.d/elastix.repo</code></p> <pre style=background:#fafafa;color:#383a42><code><span>[elastix-base]
</span><span>name=Base RPM Repository for Elastix
</span><span>mirrorlist=http://mirror.elastix.org/?release=2&arch=$basearch&repo=base
</span><span>#baseurl=http://repo.elastix.org/elastix/2/base/$basearch/
</span><span>gpgcheck=1
</span><span>enabled=1
</span><span>gpgkey=http://repo.elastix.org/elastix/RPM-GPG-KEY-Elastix
</span><span>
</span><span>[elastix-updates]
</span><span>name=Updates RPM Repository for Elastix
</span><span>mirrorlist=http://mirror.elastix.org/?release=2&arch=$basearch&repo=updates
</span><span>#baseurl=http://repo.elastix.org/elastix/2/updates/$basearch/
</span><span>gpgcheck=1
</span><span>enabled=1
</span><span>gpgkey=http://repo.elastix.org/elastix/RPM-GPG-KEY-Elastix
</span><span>
</span><span>[elastix-beta]
</span><span>name=Beta RPM Repository for Elastix
</span><span>mirrorlist=http://mirror.elastix.org/?release=2&arch=$basearch&repo=beta
</span><span>#baseurl=http://repo.elastix.org/elastix/2/beta/$basearch/
</span><span>gpgcheck=1
</span><span>enabled=0
</span><span>gpgkey=http://repo.elastix.org/elastix/RPM-GPG-KEY-Elastix
</span><span>
</span><span>[elastix-extras]
</span><span>name=Extras RPM Repository for Elastix
</span><span>mirrorlist=http://mirror.elastix.org/?release=2&arch=$basearch&repo=extras
</span><span>#baseurl=http://repo.elastix.org/elastix/2/extras/$basearch/
</span><span>gpgcheck=1
</span><span>enabled=1
</span><span>gpgkey=http://repo.elastix.org/elastix/RPM-GPG-KEY-Elastix
</span></code></pre><li><p>import the required keys:</p> <pre style=background:#fafafa;color:#383a42><code><span>rpm --import http://repo.elastix.org/elastix/RPM-GPG-KEY-Elastix
</span><span>rpm --import http://fedoraproject.org/static/217521F6.txt
</span></code></pre></ul><p>Now comes the tricky part. The mISDN modules from elastix require an older kernel than the current from centos. This might change in the future but for me, right now, this is the case.<p>Find oud the most recent mISDN version:<pre style=background:#fafafa;color:#383a42><code><span>yum deplist mISDN | grep "package:"
</span></code></pre><p>This will give you a list of mISDN versions currently known to yum. Write don’t the most recent one.<pre style=background:#fafafa;color:#383a42><code><span>package: mISDN-modules.i686 1.1.9.1-2
</span><span>package: mISDN-modules.i686 1.1.9.1-1.2.6.18_164.6.1.el5
</span><span>package: mISDN-modules.i686 1.1.9.1-1.2.6.18_194.el5
</span><span>package: mISDN-modules.i686 1.1.9.1-1.2.6.18_164.el5
</span><span>package: mISDN-modules.i686 1.1.9.1-1.2.6.18_164.11.1.el5
</span><span>package: mISDN-modules.i686 1.1.9.1-1.2.6.18_238.12.1.el5
</span><span>package: mISDN-modules.i686 1.1.9.1-1.2.6.18_194.3.1.el5
</span></code></pre><p>In this case <code>mISDN-modules.i686 1.1.9.1-2</code>.<br> So check for the kernel of this version:<pre style=background:#fafafa;color:#383a42><code><span>yum deplist mISDN-modules-1.1.9.1-2
</span></code></pre><p>Note the different syntax on the version! You need to specify <code>mISDN-$VERSION</code> and without the <code>i686</code> identifier!<pre style=background:#fafafa;color:#383a42><code><span>package: mISDN-modules.i686 1.1.9.1-2
</span><span>  dependency: kernel = 2.6.18-238.12.1.el5
</span><span>   provider: kernel-PAE.i686 2.6.18-348.el5
</span><span>   provider: kernel-debug.i686 2.6.18-348.el5
</span><span>   provider: kernel-xen.i686 2.6.18-348.el5
</span><span>   provider: kernel.i686 2.6.18-348.el5
</span><span>   provider: kernel-xen.i686 2.6.18-194.3.1.el5
</span><span>   provider: kernel.i686 2.6.18-164.11.1.el5
</span><span>   provider: kernel.i686 2.6.18-194.el5
</span><span>   provider: kernel-xen.i686 2.6.18-164.6.1.el5
</span><span>   provider: kernel.i686 2.6.18-238.12.1.el5
</span><span>   provider: kernel.i686 2.6.18-194.3.1.el5
</span><span>   provider: kernel-xen.i686 2.6.18-194.el5
</span><span>   provider: kernel-xen.i686 2.6.18-238.12.1.el5
</span><span>   provider: kernel-xen.i686 2.6.18-164.11.1.el5
</span><span>   provider: kernel.i686 2.6.18-164.6.1.el5
</span><span>  dependency: mISDN >= 1.1.9.1
</span><span>   provider: mISDN.i686 1.1.9.1-0
</span><span>   provider: mISDN.i686 1.1.9.1-2
</span><span>  dependency: module-init-tools
</span><span>   provider: module-init-tools.i386 3.3-0.pre3.1.60.el5_5.1
</span><span>  dependency: /bin/sh
</span><span>   provider: bash.i386 3.2-32.el5
</span></code></pre><p>The required kernel is <code>2.6.18-238.12.1.el5</code>. So we need to install it:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>yum</span><span> install kernel-2.6.18-238.12.1.el5
</span></code></pre><p>Depending on your setup you need to use “yum downgrade kernel 2.6.18-238.12.1.el5” instead.<p>Check if the kernel is installed:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>yum</span><span> list </span><span style=color:#50a14f>"*kernel*"
</span></code></pre><p>In my case:<pre style=background:#fafafa;color:#383a42><code><span>Installed Packages
</span><span>kernel.i686                    2.6.18-238.12.1.el5                     installed      
</span><span>kernel-PAE.i686                2.6.18-348.el5                          installed      
</span><span>Available Packages
</span><span>kernel.i686                    2.6.18-348.el5                          base           
</span><span>kernel-PAE-devel.i686          2.6.18-348.el5                          base           
</span><span>kernel-debug.i686              2.6.18-348.el5                          base           
</span><span>…
</span></code></pre><p>So I got one that I don’t want (kernel-PAE.i686 2.6.18-348.el5) and one possible upgrade which must not be installed!<p>Removing the kernel is easy. But be careful not to uninstall the wrong one!<pre style=background:#fafafa;color:#383a42><code><span>rpm -e kernel-PAE-2.6.18-348.el5
</span></code></pre><p>Checking the file <code>/boot/grub/menu.lst</code> shows only one kernel now, the correct one!<pre style=background:#fafafa;color:#383a42><code><span>
</span><span>
</span><span>
</span></code></pre><p>Now we can install mISDN and asterisk.<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>yum</span><span> install libxslt
</span><span style=color:#e45649>yum</span><span> install asterisk-mISDN mISDN
</span></code></pre><p>One possible way out of this update mess is to disable the original centos repositories and rely only on the elastix sources.<p>Now reboot<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>reboot
</span></code></pre><h2 id=misdn-setup>mISDN setup</h2><p>Scan for your mISDN card:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>/etc/init.d/mISDN</span><span> scan
</span></code></pre><p>You should get something like:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>1</span><span> mISDN compatible device(s) </span><span style=color:#e45649>found:
</span><span style=color:#a626a4>>></span><span> avmfritz
</span></code></pre><p>Now store that configuration:<pre style=background:#fafafa;color:#383a42><code><span>/etc/init.d/mISDN config
</span></code></pre><p>Not check the config file <q>/etc/mISDN.conf</q> if this is really your configuration. Depends on what setup you have. Maybe you need to change it.<p>This should give you something like:<pre style=background:#fafafa;color:#383a42><code><span>-- Loading mISDN modules --
</span><span>>> /sbin/modprobe --ignore-install capi
</span><span>>> /sbin/modprobe --ignore-install mISDN_core debug=0
</span><span>>> /sbin/modprobe --ignore-install mISDN_l1 debug=0
</span><span>>> /sbin/modprobe --ignore-install mISDN_l2 debug=0
</span><span>>> /sbin/modprobe --ignore-install l3udss1 debug=0
</span><span>>> /sbin/modprobe --ignore-install mISDN_capi
</span><span>>> /sbin/modprobe --ignore-install avmfritz protocol=0x2 layermask=0xf
</span><span>>> /sbin/modprobe --ignore-install mISDN_dsp debug=0 options=0
</span></code></pre><p>And activate on boot:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>chkconfig</span><span> mISDN on
</span><span style=color:#e45649>chkconfig --list</span><span> mISDN
</span></code></pre><p>Now you should be able to see the card in action:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>misdnportinfo
</span></code></pre><p>For me:<pre style=background:#fafafa;color:#383a42><code><span>Port  1: TE-mode BRI S/T interface line (for phone lines)
</span><span> -> Interface is Poin-To-Point.
</span><span> -> Protocol: DSS1 (Euro ISDN)
</span><span> -> childcnt: 2
</span><span>--------
</span><span>
</span><span>mISDN_close: fid(3) isize(131072) inbuf(0x8cec060) irp(0x8cec060) iend(0x8cec060)
</span></code></pre><p>Now we need to re-create the configuration in a different format *sigh*<p>[code]/usr/sbin/misdn-init config[/code]<p>And edit the file <q>/etc/misdn-init.conf</q> to match the content of <q>/etc/mISDN.conf</q>. For example in my case I had to change from PTMP mode to PTP in both files. Asterisk will read the latter file and use it for its configuration.<p>Finally edit asterisks own misdn configuration file: /etc/asterisk/misdn.conf<p>Check the section “[intern]” near the end of the file and remove/rename the section to something like:<pre class=language-ini data-lang=ini style=background:#fafafa;color:#383a42><code class=language-ini data-lang=ini><span style=color:#a626a4>[fpstn]
</span><span style=color:#a0a1a7>; define your ports, e.g. 1,2 (depends on mISDN-driver loading order)
</span><span style=color:#e45649>ports</span><span style=color:#a626a4>=</span><span style=color:#c18401>1</span><span style=color:#a626a4>,</span><span style=color:#c18401>2
</span><span style=color:#a0a1a7>; context where to go to when incoming Call on one of the above ports
</span><span style=color:#e45649>context</span><span style=color:#a626a4>=</span><span>from</span><span style=color:#a626a4>-</span><span>pstn
</span><span style=color:#e45649>msns</span><span style=color:#a626a4>=*
</span></code></pre><p>Again this depends heavly on your setup. Important is that the section is named [fpstn] and “context=from-pstn” since we need that later.<h2 id=asterisk-setup>asterisk setup</h2><p>After some hours of googling and trial&error I finally came up with some useful resources on the net:<p>At https://confluence.terena.org/pages/viewpage.action?pageId=131104 there is quite a good explanation of how to set up an asterisk VOIP gateway (SIP trunk). Still with some issues but it was a pretty good base. Also it did not use mISDN.<p>Asterisk had to be configured to provide a SIP user (the trunk). So replace the file “/etc/asterisk/sip.conf” with the following content:<pre class=language-ini data-lang=ini style=background:#fafafa;color:#383a42><code class=language-ini data-lang=ini><span style=color:#a626a4>[general]
</span><span>context=guest                   </span><span style=color:#a0a1a7>; Default context for incoming calls (non authenticated)
</span><span>
</span><span>disallow=all                    </span><span style=color:#a0a1a7>; First disallow all codecs
</span><span style=color:#a0a1a7>;allow=g729
</span><span style=color:#e45649>allow</span><span style=color:#a626a4>=</span><span>gsm
</span><span style=color:#e45649>allow</span><span style=color:#a626a4>=</span><span>alaw
</span><span style=color:#e45649>allow</span><span style=color:#a626a4>=</span><span>ulaw
</span><span>
</span><span>language=en                     </span><span style=color:#a0a1a7>; Default language setting for all users/peers
</span><span>
</span><span style=color:#e45649>localnet</span><span style=color:#a626a4>=</span><span style=color:#c18401>192.168.0.0/255</span><span style=color:#a626a4>.</span><span style=color:#c18401>255</span><span style=color:#a626a4>.</span><span style=color:#c18401>0</span><span style=color:#a626a4>.</span><span style=color:#c18401>0</span><span>; All RFC </span><span style=color:#c18401>1918</span><span> addresses are local networks
</span><span>localnet=10.0.0.0/255.0.0.0     </span><span style=color:#a0a1a7>; Also RFC1918
</span><span>localnet=172.20.0.0/255.255.0.0          </span><span style=color:#a0a1a7>; Another RFC1918 with CIDR notation
</span><span>localnet=169.254.0.0/255.255.0.0 </span><span style=color:#a0a1a7>;Zero conf local network
</span><span>
</span><span style=color:#e45649>jbenable</span><span style=color:#a626a4>=</span><span style=color:#c18401>yes
</span><span style=color:#e45649>jbforce</span><span style=color:#a626a4>=</span><span style=color:#c18401>yes
</span><span style=color:#e45649>jbimpl </span><span style=color:#a626a4>=</span><span> fixed
</span><span>
</span><span style=color:#a626a4>[600]
</span><span style=color:#e45649>username</span><span style=color:#a626a4>=</span><span style=color:#c18401>600
</span><span style=color:#e45649>secret</span><span style=color:#a626a4>=</span><span>somesecret600
</span><span style=color:#e45649>type</span><span style=color:#a626a4>=</span><span>friend
</span><span style=color:#e45649>host</span><span style=color:#a626a4>=</span><span>dynamic
</span><span style=color:#e45649>context</span><span style=color:#a626a4>=</span><span>sip
</span><span style=color:#e45649>insecure</span><span style=color:#a626a4>=</span><span>port</span><span style=color:#a626a4>,</span><span>invite
</span></code></pre><p>This is a quite short configuration, but we only need one account for starface to hook up to the asterisk server. You should change the secret of course. The “insecure=port,invite” was necessary since asterisk otherwise rejected the starface pbx when making calls, although the initial registration using the username and password was successful. In pre-1.8 versions of asterisk this was “insecure=very”, but this is not working anymore.<p>So now we have two parts in the asterisk box, an mISDN trunk and a SIP account which will act as a trunk. Now we need to pass calls between them. Therefore we configure some dialplans in the “/etc/asterisk/extensions.conf”:<pre class=language-ini data-lang=ini style=background:#fafafa;color:#383a42><code class=language-ini data-lang=ini><span style=color:#a626a4>[general]
</span><span style=color:#e45649>static</span><span style=color:#a626a4>=</span><span style=color:#c18401>yes
</span><span style=color:#e45649>writeprotect</span><span style=color:#a626a4>=</span><span style=color:#c18401>yes
</span><span>
</span><span style=color:#a626a4>[from-pstn]
</span><span style=color:#e45649>exten </span><span style=color:#a626a4>=> </span><span>_1234</span><span style=color:#a626a4>.,</span><span style=color:#c18401>1</span><span style=color:#a626a4>,</span><span style=color:#0184bc>Dial</span><span>(SIP</span><span style=color:#a626a4>/</span><span style=color:#c18401>600</span><span style=color:#a626a4>/${EXTEN}</span><span>)
</span><span>
</span><span style=color:#a626a4>[sip]
</span><span style=color:#e45649>exten </span><span style=color:#a626a4>=> </span><span>_0</span><span style=color:#a626a4>.,</span><span style=color:#c18401>1</span><span style=color:#a626a4>,</span><span style=color:#0184bc>Dial</span><span>(misdn/g</span><span style=color:#a626a4>:</span><span>fpstn</span><span style=color:#a626a4>/${EXTEN}</span><span>)
</span></code></pre><p>So everthing that comes in using ISDN (from-pstn) will be directed to the SIP account 600 passing on the original number so that starface can use it. The rule “_1234.” must be adapted to match your telephone number.<p>Also everything that comes from the SIP account (starface) and starts with a zero will be sent to ISDN.<p>Tweaking the rules will be a task, then everybody needs something different here I guess.<p>Finally re-start asterisk:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>/etc/init.d/asterisk</span><span> restart
</span></code></pre><h2 id=starface>starface</h2><p>Setting up Starface was the real easy part. Get the ISO image, install into the KVM server (Ubuntu 12.04 using KVM as virtualization). Starface officially supports only vmware, but is still based on Linux. I had to use “pcnet” as network interface and “sata” for the disk since the “virtio” module won’t work with Starface. Room for improvement ;-)<p>Installing Starface was simply booting from the ISO image and installing to the disk. The SIP trunk could now easly be added using the following settings:<ul><li>Create a new line<li>Select “new” as provider<li>Use the following provider settings (leave other settings to default): <ul><li>host=&LTyour-sip-trunk-ip></ul><li>Enter the username and password from above (600, somesecret600)</ul><h3 id=setting-up-starface>setting up starface</h3><p>This is pretty straight forward now. Provision your phone. Setup a number. And make a call!<h2 id=some-checks>Some checks</h2><h3 id=sip-peers>SIP peers</h3><p>Check if starface registeres with your sip trunk using the asterisk command line on the gateway:<pre class=language-bash data-lang=bash style=background:#fafafa;color:#383a42><code class=language-bash data-lang=bash><span style=color:#e45649>asterisk -r
</span><span style=color:#e45649>sip</span><span> show peers
</span></code></pre><h3 id=sip-debugging>SIP Debugging</h3><p>SIP Debugging can be enabled using the asterisk command <code>sip set debug on</code>.<h3 id=turn-on-the-full-log>Turn on the full log</h3><p>Edit <code>/etc/asterisk/logger.conf</code> and comment in the <code>full</code> line</section></div></article></main><aside class="col-lg-3 order-first order-lg-0 sticky-top mt-lg-5 de-m-collapsible"><div class="de-sidebox de-m-right collapse d-lg-block" id=rightSidebox><div class="d-flex d-md-none pb-3"><div class=row><div class=col><a title="Link to my GitHub profile" class=link-secondary href=https://github.com/ctron target=_blank> <svg class="feather feather-github" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg> </a></div><div class=col><a title="Link to my Mastodon profile" class=link-secondary href=https://mastodon.dentrassi.de/@ctron rel=me target=_blank> <svg viewbox="0 0 24 24" fill=currentColor height=24 stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M23.193 7.879c0-5.206-3.411-6.732-3.411-6.732C18.062.357 15.108.025 12.041 0h-.076c-3.068.025-6.02.357-7.74 1.147 0 0-3.411 1.526-3.411 6.732 0 1.192-.023 2.618.015 4.129.124 5.092.934 10.109 5.641 11.355 2.17.574 4.034.695 5.535.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.129.539c-2.165-.074-4.449-.233-4.799-2.891a5.499 5.499 0 0 1-.048-.745s2.125.52 4.817.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.507.475-6.507zm-4.024 6.709h-2.497V8.469c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.312v3.349h-2.483v-3.35c0-1.536-.602-2.312-1.802-2.312-1.085 0-1.628.655-1.628 1.944v6.119H4.832V8.284c0-1.289.328-2.313.987-3.07.68-.758 1.569-1.146 2.674-1.146 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.304z"/></svg> </a></div><div class=col><a title="Link to my matrix address" class=link-secondary href=https://matrix.to/#%2F%40ctron%3Adentrassi.de target=_blank> <svg class="feather feather-message-square" viewbox="0 0 24 24" fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> </a></div></div></div><div class="de-c-toc mb-4"><h2>Table of Content</h2><ul class="list-unstyled de-c-toc__first" id=toc><li><a class=link-body-emphasis href=#misdn-gateway-setup>mISDN + gateway setup</a><li><a class=link-body-emphasis href=#misdn-setup>mISDN setup</a><li><a class=link-body-emphasis href=#asterisk-setup>asterisk setup</a><li><a class=link-body-emphasis href=#starface>starface</a> <ul class="list-unstyled de-c-toc__second"><li><a class=link-body-emphasis href=#setting-up-starface>setting up starface</a></ul><li><a class=link-body-emphasis href=#some-checks>Some checks</a> <ul class="list-unstyled de-c-toc__second"><li><a class=link-body-emphasis href=#sip-peers>SIP peers</a><li><a class=link-body-emphasis href=#sip-debugging>SIP Debugging</a><li><a class=link-body-emphasis href=#turn-on-the-full-log>Turn on the full log</a></ul></ul></div><div class="d-lg-block d-none"><div class="de-c-recent-posts mb-2"><h2 class=d-flex><span>Recent Posts</span> <span class=de-c-title__action> <a href=https://staging.dentrassi.de/archive>Archive</a> </span></h2><ul class=list-unstyled><li><a title="trunk-ng, the fork of trunk" class=link-body-emphasis href=/2023/10/14/trunk-ng-the-fork-of-trunk/>trunk-ng, the fork of trunk</a><li><a title="A fresh start" class=link-body-emphasis href=/2023/10/03/a-fresh-start/>A fresh start</a><li><a title="Using Ingress on OpenShift backed by Routes" class=link-body-emphasis href=/2021/05/21/using-ingress-on-openshift-backed-by-routes/>Using Ingress on OpenShift backed by Routes</a><li><a title="Recovering from an expired OpenShift certificate" class=link-body-emphasis href=/2021/01/18/recovering-from-an-expired-openshift-certificate/>Recovering from an expired OpenShift certificate</a><li><a title="A Rusty frontend: Patternfly & Yew" class=link-body-emphasis href=/2021/01/08/rusty-frontend-patternfly-yew/>A Rusty frontend: Patternfly & Yew</a></ul></div></div></div></aside></div></div><footer class="bg-body-tertiary py-5 mt-lg-5"><div class="container text-body-secondary"><div class=row><div class="col-12 col-lg mb-2">© ctron's blog – All rights reserved</div><div class="col-12 col-lg"><ul class="list-unstyled mb-0"><li><a class=link-secondary href=https://staging.dentrassi.de/legal/disclaimer/>Disclaimer</a><li><a class=link-secondary href=https://staging.dentrassi.de/legal/impress/>Impressum / Impress</a><li><a class=link-secondary href=https://staging.dentrassi.de/legal/privacy/>Datenschutzerklärung / Privacy Policy</a></ul></div><div class="col-12 col-lg"><a class=link-secondary href=https://staging.dentrassi.de/legal/contact/>Contact</a></div></div></div></footer><script src="https://staging.dentrassi.de/js/bootstrap.bundle.min.js?h=82f64f62bb03c1bc1824"></script><script src="https://staging.dentrassi.de/elasticlunr.min.js?h=4f648b9e42abdef9c436" defer></script><script src="https://staging.dentrassi.de/js/search.js?h=ed51a29cb343a0c8a535" defer></script><script>window.searchIndexLocation="https://staging.dentrassi.de/search_index.en.json?h=673020bb91ef236bd18b"</script>