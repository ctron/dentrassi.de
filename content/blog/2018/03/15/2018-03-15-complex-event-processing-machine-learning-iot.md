---
id: 3814
title: 'CEP &#038; Machine learning for IoT – Drools on Kura'
date: '2018-03-15T18:05:13+01:00'
author: 'Jens Reimann'
layout: post
guid: 'https://dentrassi.de/?p=3814'
permalink: /2018/03/15/complex-event-processing-machine-learning-iot/
fabulous-fluid-layout-option:
    - default
fabulous-fluid-header-image:
    - default
fabulous-fluid-featured-image:
    - default
tc-thumb-fld:
    - 'a:2:{s:9:"_thumb_id";i:3824;s:11:"_thumb_type";s:10:"attachment";}'
categories:
    - Development
    - IoT
    - 'Technical Stuff'
tags:
    - Drools
    - Eclipse
    - IoT
    - Kura
    - OSGi
---

Machine learning and predicate maintenance we are the role models of IoT use cases. Having an IoT gateway allows you to pre-process data before you send it upstream to your cloud. It also allows you to do local decisions, without the actual need for a cloud upload. But as you know from sitting at your favorite restaurant, staring at the menu, making decisions can be quite hard ;-) Complex event process and machine learning models can help you with IoT use cases though.

<!-- more -->

[Eclipse Kura](https://eclipse.org/kura) is an open source IoT gateway with a focus on industrial use cases. [Drools](https://drools.org/) is an open source rule engine and, with Drools Fusion, provides complex event processing. It also supports making decisions based on [Predictive Model Markup Language](https://en.wikipedia.org/wiki/Predictive_Model_Markup_Language) (PMML) based models. So why not bring both components together?! PMML’s can be used for all kind of scenarios. But the classic IoT use case would probably be to do predicate maintenance, based on a PMML generated by your machine learning solution on the cloud. Sending back the “learned” knowledge to the edge gateway for local processing.

### Installation

The [Drools addon for Kura](https://dentrassi.de/kura-addons/#drools) provide two DPs (the package type used by Kura) which can be deployed in order to extend Kura with Drools.

[![](https://dentrassi.de/wp-content/uploads/Selection_455.png)](https://dentrassi.de/wp-content/uploads/Selection_455.png)

**Note:** If you don’t have a Raspberry Pi at hand, or don’t want to install Kura on some “real” device. You can always use the [Kura Emulator docker image](https://hub.docker.com/r/ctron/kura-emulator/) (see also [Developing for Eclipse Kura in Windows](https://dentrassi.de/2017/03/21/developing-for-eclipse-kura-on-windows/)).

### Setup

Once the components are installed, it is possible to create a new Drools instance by clicking in the blue “+” on the left side of the Kura services area. Create a new component of the type `de.dentrassi.kura.addons.drools.component.DroolsInstance`. Choose any unused ID and click “Apply”. It might be necessary to reload the Web UI of Kura at this point as the refresh doesn’t properly work. When the service is listed in the left hand side “services” list, select it in order to configure:

[![](https://dentrassi.de/wp-content/uploads/Selection_456.png)](https://dentrassi.de/wp-content/uploads/Selection_456.png)

The actual rules document comes from the file [SimpleScorecard.pmml](https://github.com/mpbravo/brms-pmml-example/blob/master/src/main/resources/SimpleScorecard.pmml) of the PMML drools example [mpbravo/brms-pmml-example](https://github.com/mpbravo/brms-pmml-example). Also be sure to set the file type to “Predictive Model Markup Language”. Save the changes by clicking on “Apply”.

Next we will use Kura Wires in order to mesh up the model with some “data”. A need to use a timer as input source, as Kura currently doesn’t offer any kind of value creating like a function or sine curve. So create a new “timer”, you can leave the default of 10 seconds. Add a new logger, which we simply use for testing, you should set the “verbosity” to “VERBOSE”. And then create a new “DroolsProcess” component with the following configuration:

<dl><dt>ID</dt><dd>`pmml1` – The ID of the drools session</dd><dt>Fire all rules</dt><dd>`true` – After the fact has been injected, rules have to fired</dd><dt>Delete after fire</dt><dd>`true` – After the rules have been fired, we can remove the fact from the session</dd><dt>Fact Package</dt><dd>`org.drools.scorecards.example` – The package name, from the rules model</dd><dt>Fact Type</dt><dd>`SampleScore` – The type name, from the rules model</dd><dt>Inputs</dt><dd>`age=TIMER` – comma separated list for Wire record names to fact object properties</dd><dt>Outputs</dt><dd>`result=scorecard_calculatedScore` – comma separated list for Wire record names to fact object properties</dd></dl>Finally wire that all up:

[![](https://dentrassi.de/wp-content/uploads/Selection_457.png)](https://dentrassi.de/wp-content/uploads/Selection_457.png)

### Results

Looking at the Kura log file `/var/log/kura.log` should show you something like (where `result` is coming from the PMML model):

```

2018-03-15 16:07:12,165 [DefaultQuartzScheduler_Worker-6] INFO  d.d.k.a.d.c.w.DroolsProcess - Result - type: class java.lang.Double, value: 24.0
2018-03-15 16:07:12,165 [DefaultQuartzScheduler_Worker-6] INFO  o.e.k.i.w.l.Logger - Received WireEnvelope from de.dentrassi.kura.addons.drools.component.wires.DroolsProcess-1521129031885-7
2018-03-15 16:07:12,165 [DefaultQuartzScheduler_Worker-6] INFO  o.e.k.i.w.l.Logger - Record List content: 
2018-03-15 16:07:12,165 [DefaultQuartzScheduler_Worker-6] INFO  o.e.k.i.w.l.Logger -   Record content: 
2018-03-15 16:07:12,165 [DefaultQuartzScheduler_Worker-6] INFO  o.e.k.i.w.l.Logger -     result : 24.0
2018-03-15 16:07:12,165 [DefaultQuartzScheduler_Worker-6] INFO  o.e.k.i.w.l.Logger - 
```

### Conclusion

Of course the example is rather trivial. And the actual model and the way we wired it up is just an example. But of course you will bring your own model, based on your machine learning solutions, and have your own data to wire up. So go ahead and explore.
